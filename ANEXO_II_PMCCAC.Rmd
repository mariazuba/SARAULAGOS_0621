---
title: "ANEXO II"
subtitle: "Implementación de un Modelo con dinámica en edad e información en talla (modelo alternativo) para sardina austral de la Región de Los Lagos"
lang: es
output: pdf_document
toc: TRUE
header-includes:
- \usepackage{draftwatermark}
- \SetWatermarkText{}
- \usepackage{fancyhdr}
- \usepackage{graphicx}
- \usepackage{parskip}
- \usepackage{caption}
- \captionsetup[table]{name=\textbf{Tabla},labelsep=period}
- \captionsetup[figure]{name=\textbf{Figura},labelsep=period}
- \captionsetup{justification=justified,format=plain,font=small,labelfont=bf,margin=40pt}
- \pagestyle{fancy}
- \usepackage{geometry}
- \geometry{top=1.5cm, bottom=1cm, left=2.5cm, right=2.5cm}
- \usepackage{helvet}
- \renewcommand{\familydefault}{\sfdefault}

- \newcommand{\sietepuntos}{\fontsize{7pt}{\baselineskip}\selectfont}
- \newcommand{\cincopuntos}{\fontsize{6pt}{\baselineskip}\selectfont}

- \addtolength{\headheight}{4.5\baselineskip}
- \setlength{\headheight}{70pt}
- \setlength{\footskip}{5pt}
- \setlength{\textheight}{658pt}
- \fancyhead[CO,CE]{\includegraphics[height=1.5cm]{logoifop.png}\\ \sietepuntos INSTITUTO DE FOMENTO PESQUERO / DIVISION INVESTIGACION PESQUERA}
- \fancyhead[LO,LE]{ }
- \fancyhead[RO,RE]{ }
- \renewcommand{\headrulewidth}{0.5pt}
- \fancyfoot[C]{\cincopuntos \thepage \\ \vspace{-0.2cm} ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ \\ \vspace{-0.2cm} \cincopuntos CONVENIO DE DESEMPEÑO 2020 IFOP/SUBSECRETARÍA DE ECONOMíA Y EMT \\ \vspace{-0.1cm} INFORME FINAL. SARDINA AUSTRAL, REGIÓN DE LOS LAGOS, 2021. \textbf{ANEXO II}}
---


```{r llama codigos, warning=F, include=T, message=F, echo=FALSE}
library(knitr) # para generar reporte Rmarkdown
library(stringr)
library(reshape) 
library(dplyr) 
library(ggplot2)
library(ggthemes) # para ggplot
library(patchwork) # para unir gráficos de ggplot
library(strucchange) # libreria utilizada para análisis de quiebres

dir.Fig     <-"Figuras/" # carpeta de las figuras utilizadas y generadas en este estudio
fig         <-c("pdf","bmp") # formato de figuras generadas por este código
dir.0       <-getwd() # directorio de trabajo 
dir.1       <-paste(dir.0,"/codigos_admb",sep="") # carpeta de códigos ADMB 
dir.2       <-paste(dir.0,"/Retrospectivobase",sep="") # carpeta de códigos ADMB 
dir.3       <-paste(dir.0,"/Retrospectivoalternativo",sep="") # carpeta de códigos ADMB 
dir.4       <-paste(dir.0,"/Verosimilitudalternativo",sep="") # carpeta de códigos ADMB 
dir.5       <-paste(dir.0,"/Verosimilitudbase",sep="") # carpeta de códigos ADMB 

dir.fun     <-paste(dir.0,"/funciones/",sep="") # carpeta de funciones utilizadas en este informe
source(paste(dir.fun,"functions.R",sep="")) # funciones para leer .dat y .rep
source(paste(dir.fun,"Fn_PBRs.R",sep="")) # funciones para leer .dat y .rep
```

```{r CORRE MODELO BASE SEPTIEMBRE, eval=FALSE, echo=FALSE, warning=FALSE,include=F}
#Primer paso correr códigos 
setwd(dir.1)
#Asesoría Septiembre 2021
system("~/admb-12.2/admb MTT0920")
system("./MTT0920")
```

```{r CORRE MODELO ALTERNATIVO SEPTIEMBRE, eval=FALSE, echo=FALSE, warning=FALSE,include=F}
#Primer paso correr códigos 
setwd(dir.1)
system("~/admb-12.2/admb MAT0920")
system("./MAT0920")
```

```{r datos_rep_std, warning=F, include=T, message=F, echo=FALSE}
setwd(dir.1)
#Asesoría septiembre MODELO BASE 
data.0   <- lisread(paste(dir.1,"MTT0920.dat", sep='/'));
names(data.0)<-str_trim(names(data.0), side="right")
rep0     <- reptoRlist("MTT0920.rep")                                               
std0     <- read.table("MTT0920.std",header=T,sep="",na="NA",fill=T) 

#Asesoría septiembre MODELO ALTERNATIVO 
data.1   <- lisread(paste(dir.1,"MAT0920.dat", sep='/'));
names(data.1)<-str_trim(names(data.1), side="right")
rep1     <- reptoRlist("MAT0920.rep")                                               
std1     <- read.table("MAT0920.std",header=T,sep="",na="NA",fill=T) 

```

```{r CARPETA RETROSPECTIVOBase, eval=FALSE, echo=FALSE, warning=FALSE,include=F}
source(paste(getwd(),"/funciones/Fn_Retrospectivo.R",sep="")) 
Retrospectivobase("MTT0920",dir.0,dir.1,"/Retrospectivobase",system="mac") 
```

```{r CARPETA RETROSPECTIVOAlternativo, eval=FALSE, echo=FALSE, warning=FALSE,include=F}
source(paste(getwd(),"/funciones/Fn_Retrospectivo.R",sep="")) 
Retrospectivoalternativo("MAT0920",dir.0,dir.1,"/Retrospectivoalternativo",system="mac") 
```

```{r CARPETA VEROSIMILITUDBase, eval=FALSE, echo=FALSE, warning=FALSE,include=F}
source(paste(getwd(),"/funciones/Fn_Verosimilitud.R",sep="")) 
Verosimilitudbase("MTT0920",dir.0,dir.1,"/Verosimilitudbase",system="mac") 
```

```{r CARPETA VEROSIMILITUDAlternativo, eval=FALSE, echo=FALSE, warning=FALSE,include=F}
source(paste(getwd(),"/funciones/Fn_Verosimilitud.R",sep="")) 
Verosimilitudalternativo("MAT0920",dir.0,dir.1,"/Verosimilitudalternativo",system="mac") 
```

```{r CARPETA ProyeccionAlternativo_Asesoriasept2019, eval=FALSE, echo=FALSE, warning=FALSE,include=F}
source(paste(getwd(),"/funciones/Fn_CBA.R",sep="")) 

admb<-"MAT0919"
Carpeta<-"/cba_septiembre2019_alternativo"
system="mac"
l_escRec=166

CBA(admb,dir.0,dir.1,Carpeta,system,l_escRec)
  
```

```{r CARPETA ProyeccionAlternativo_Asesoriasept2020, eval=FALSE, echo=FALSE, warning=FALSE,include=F}
source(paste(getwd(),"/funciones/Fn_CBA.R",sep="")) 

admb<-"MAT0920"
Carpeta<-"/cba_septiembre2020_alternativo"
system="mac"
l_escRec=169

CBA(admb,dir.0,dir.1,Carpeta,system,l_escRec)
  
```

```{r CARPETA ProyeccionBase_Asesoriasept2019, eval=FALSE, echo=FALSE, warning=FALSE,include=F}
source(paste(getwd(),"/funciones/Fn_CBA.R",sep="")) 

admb<-"MTT0819"
Carpeta<-"/cba_septiembre2019_base"
system="mac"
l_escRec=188

CBA(admb,dir.0,dir.1,Carpeta,system,l_escRec)
  
```

```{r CARPETA ProyeccionBase_Asesoriasept2020, eval=FALSE, echo=FALSE, warning=FALSE,include=F}
source(paste(getwd(),"/funciones/Fn_CBA.R",sep="")) 

admb<-"MTT0920"
Carpeta<-"/cba_septiembre2020_base"
system="mac"
l_escRec=186

CBA(admb,dir.0,dir.1,Carpeta,system,l_escRec)
  
```

```{r correr codigos asesorías previas, eval=FALSE, echo=FALSE, warning=FALSE}
#Primer paso correr códigos 
setwd(dir.1)
#modelo base
#system("~/admb-12.2/admb MTT0520")
#system("./MTT0520")

#system("./MTT0819")
##system("~/admb-12.2/admb MTT0819")

#modelo alternativo
#system("~/admb-12.2/admb MAT0420")
#system("./MAT0420")

#alternativo septiembre 2019
#system("~/admb-12.2/admb MAT0919")
#system("./MAT0919")

#alternativo julio 2019
#system("~/admb-12.2/admb MAT0619")
#system("./MAT0619")

```

```{r datos_rep_, warning=F, include=T, message=F, echo=FALSE}
setwd(dir.1)
#modelo base junio 2020
data0   <- lisread(paste(dir.1,"MTT0520.dat", sep='/'));names(data0)<-str_trim(names(data0), side="right")
rep.0     <- reptoRlist("MTT0520.rep")                                          
std.0     <- read.table("MTT0520.std",header=T,sep="",na="NA",fill=T) 

#modelo base septiembre 2019
data0a   <- lisread(paste(dir.1,"MTT0819.dat", sep='/'));names(data0a)<-str_trim(names(data0a), side="right")
rep.0a     <- reptoRlist("MTT0819.rep")                                        
std.0a     <- read.table("MTT0819.std",header=T,sep="",na="NA",fill=T) 

#modelo alternativo junio 2020
data1   <- lisread(paste(dir.1,"MAT0420.dat", sep='/'));names(data1)<-str_trim(names(data1), side="right")
rep.1     <- reptoRlist("MAT0420.rep")                                          
std.1     <- read.table("MAT0420.std",header=T,sep="",na="NA",fill=T) 

#modelo alternativo septiembre 2019
data2   <- lisread(paste(dir.1,"MAT0919.dat", sep='/'));names(data2)<-str_trim(names(data2), side="right")
rep.2     <- reptoRlist("MAT0919.rep")                                          
std.2     <- read.table("MAT0919.std",header=T,sep="",na="NA",fill=T) 

#modelo alternativo junio 2019
data3   <- lisread(paste(dir.1,"MAT0619.dat", sep='/'));names(data3)<-str_trim(names(data3), side="right")
rep.3     <- reptoRlist("MAT0619.rep")                                          
std.3     <- read.table("MAT0619.std",header=T,sep="",na="NA",fill=T) 

```

\pagebreak

## 1.	ANTECEDENTES

Uno de los objetivos del Proyecto “Estatus y Posibilidades de Explotación Biológicamente Sustentables de los Principales Recursos Pesqueros Nacionales año 2018” se refiere al Programa de Mejoramiento Continuo de la Calidad de Asesoría Científica (PMCCAC,) el cual se enfoca en sintetizar las brechas de datos, información y conocimiento en relación con la situación general de una pesquería y de esta forma una sistematización para el desarrollo continuo de la asesoría científica.

Una importante fuente de información, que aporta al mejoramiento, lo constituye la revisión por pares, la cual realiza una revisión de todo el proceso de evaluación de un recurso por parte de expertos externos e independientes quienes reportan una serie de observaciones y recomendaciones de corto y mediano plazo. La evaluación de stock de sardina austral (*Sprattus fuegensis*) de aguas interiores de la Isla de Chiloé, fue objeto de este proceso de revisión, cuyos detalles están contenidos en el reporte técnico Ernst *et al*. (2015). Una de las recomendaciones de dicho reporte, fue considerar un modelo de evaluación alternativo al actualmente en uso.

El enfoque de modelación utilizado hasta ahora, corresponde a un modelo talla estructurado (Sullivan *et al*. 1990), quien modela la abundancia poblacional en función de la probabilidad de los individuos de crecer de una talla a la siguiente.

Como parte de las tareas de largo plazo y con el objetivo de dar respuesta a la recomendación de la revisión por pares, IFOP ha estado trabajando en la implemntación de un modelo con observaciones en tallas y dinámica en edades (Deriso *et al*. 1985), coherente con los procesos biológico-pesqueros. Lo anterior con la finalidad de generar un modelo base que pueda ser contrastado con el actual modelo en uso. Para poder realizar el contraste entre el actual modelo y el modelo alternativo se ha estado desarrollando un modelo anual con información en tallas y dinámica en edad en año calendario (MAET) para el período 2002-2020. El actual reporte resume los resultados de los talleres internos realizado por IFOP durante los primeros meses del año en curso y algunas recomendaciones del Comité científico del mes de marzo.


## 2. METODOLOGÍA 

El Programa de Mejoramiento Continuo de la Calidad de Asesoría Científica (PMCCAC,) se enfoca en sintetizar las brechas de datos, información y conocimiento en relación con la situación general de una pesquería y de esta forma una sistematización para el desarrollo continuo de la asesoría científica.

Una importante fuente de información, que aporta al mejoramiento, lo constituye la revisión por pares, la cual realiza una revisión de todo el proceso de evaluación de un recurso por parte de expertos externos e independientes quienes reportan una serie de observaciones y recomendaciones de corto y mediano plazo. La evaluación de stock de sardina austral (*Sprattus fuegensis*) de aguas interiores de la Isla de Chiloé, fue objeto de este proceso de revisión, cuyos detalles están contenidos en el reporte técnico Ernst *et al*. (2015). Una de las recomendaciones de dicho reporte, fue considerar un modelo de evaluación alternativo al actualmente en uso.

El enfoque de modelación utilizado hasta ahora, corresponde a un modelo talla estructurado (Sullivan *et al*. 1990), quien modela la abundancia poblacional en función de la probabilidad de los individuos de crecer de una talla a la siguiente.

Como parte de las tareas de largo plazo y con el objetivo de dar respuesta a la recomendación de la revisión por pares, IFOP ha estado trabajando en la implemntación de un modelo con observaciones en tallas y dinámica en edades (Deriso *et al*. 1985), coherente con los procesos biológico-pesqueros. Lo anterior con la finalidad de generar un modelo base que pueda ser contrastado con el actual modelo en uso. Para poder realizar el contraste entre el actual modelo y el modelo alternativo se ha estado desarrollando un modelo anual con información en tallas y dinámica en edad en año calendario (modelo alternativo) para el período 2002-2020.

El modelo alternativo propuesto, se basa en el análisis estadístico de la dinámica de estructuras de tallas anual de la flota (período 2002- 2020) y de los cruceros acústicos. Se utilizan también como índices, los desembarques totales (período 2006 - 2020), biomasa estimada por el crucero y la captura por unidad de esfuerzo (CPUE) estandarizada. Se utilizan las mismas fuentes de información en ambos enfoques de modelación.

El modelamiento de la dinámica de la sardina austral en aguas interiores de la Región de Los Lagos, es en año calendario, vale decir que el cumpleaños ocurre a inicios de año (inicios de enero), por lo cual el desove (dt) al ser establecido a mediados de año, corresponde a un valor de 0,58. De igual manera, el crucero de evaluación directa, representa a la población en el período del año en que se realiza (dt variable). Por otra parte, el peso medio es empleado para generar las estimaciones de biomasa acústica tanto del crucero de verano y otoño, desembarques y biomasa total. Se mantienen los principales supuestos en ambos enfoques de modelación (modelo base con dinámica en tallas y modelo alternativo con dinámica en edad).

El método alternativo es empleado bajo un enfoque estructurado en edades que utiliza información en tallas agrupada en año calendario y que incorpora los siguientes elementos:

-   Modelo de dinámica poblacional estructurada por edad.
-   Modelos de las observaciones y penalizaciones a priori que permiten relacionar el modelo de dinámica con las observaciones.
-   Identificación de la estructura del error a través de funciones de log-verosimilitud negativas.
-   Proceso de estimación de los parámetros desconocidos del modelo de dinámica a través de un algoritmo que minimiza la función objetivo total, contrastando las observaciones con las estimaciones deducidas del modelo de dinámica.

Adicionalmente, la \textbf{Tabla \ref{Tab12}} muestra la comparación de estructura, datos, parámetros y supuestos entre el modelo base actual y alternativo.

\vspace{0.5cm}

\small

+-----------------------------------+------------------------------------+-----------------------------------+
| Estructura del modelo             | Modelo base actual                 | Modelo alternativo                |
+===================================+====================================+===================================+
| Temporalidad                      | Año calendario                     | Año calendario                    |
+-----------------------------------+------------------------------------+-----------------------------------+
| Dinámica poblacional              | Tallas                             | Edad                              |
+-----------------------------------+------------------------------------+-----------------------------------+
| Composición de las capturas       | Tallas                             | Tallas                            |
+-----------------------------------+------------------------------------+-----------------------------------+
| Número de años                    | 19                                 | 19                                |
+-----------------------------------+------------------------------------+-----------------------------------+
| Años                              | 2002 - 2020                        | 2002 - 2020                       |
+-----------------------------------+------------------------------------+-----------------------------------+
| Número de edades                  | \-                                 | 5                                 |
+-----------------------------------+------------------------------------+-----------------------------------+
| Número de tallas                  | 30                                 | 30                                |
+-----------------------------------+------------------------------------+-----------------------------------+
| Rango de tallas                   | 5,5 - 20 cm                        | 5,5 - 20 cm                       |
+-----------------------------------+------------------------------------+-----------------------------------+
| **Datos y parámetros de entrada** |                                    |                                   |
+-----------------------------------+------------------------------------+-----------------------------------+
| Desembarques                      | 2002 - 2020                        | 2002 - 2020                       |
+-----------------------------------+------------------------------------+-----------------------------------+
| Biomasa acústica                  | 2006,2008,2011,2013-2020           | 2006,2008,2011,2013-2020          |
+-----------------------------------+------------------------------------+-----------------------------------+
| Composición de tallas flota       | 2005 - 2020                        | 2005 - 2020                       |
+-----------------------------------+------------------------------------+-----------------------------------+
| Composición de tallas crucero     | 2006, 2008, 2011, 2013 - 2020      | 2006, 2008, 2011, 2013 - 2020     |
+-----------------------------------+------------------------------------+-----------------------------------+
| Madurez sexual                    | Talla                              | Talla                             |
+-----------------------------------+------------------------------------+-----------------------------------+
| Peso medio                        | Talla (constante entre años)       | Talla (constante entre años)      |
+-----------------------------------+------------------------------------+-----------------------------------+
| Parámetros de crecimiento         | Matriz de probabilidad talla-talla | Matriz de probabilidad edad-talla |
+-----------------------------------+------------------------------------+-----------------------------------+
| Loo                               | 17,7 cm                            | 17,7 cm                           |
+-----------------------------------+------------------------------------+-----------------------------------+
| k                                 | 0,78 año-1                         | 0,78 año-1                        |
+-----------------------------------+------------------------------------+-----------------------------------+
| Lo                                | 8                                  | 8                                 |
+-----------------------------------+------------------------------------+-----------------------------------+
| Mortalidad natural (año-1)        | 0,83                               | 0,83                              |
+-----------------------------------+------------------------------------+-----------------------------------+
| **Supuestos del modelo**          |                                    |                                   |
+-----------------------------------+------------------------------------+-----------------------------------+
| Reclutamiento                     | Ro más desvíos                     | Ro más desvíos                    |
+-----------------------------------+------------------------------------+-----------------------------------+
| Selectividad                      | Logística y en bloques             | Logística y en bloques            |
+-----------------------------------+------------------------------------+-----------------------------------+
| Capturabilidad                    | Prior (0,65 y cv 0,15)             | Prior (0,65 y cv 0,15)            |
+-----------------------------------+------------------------------------+-----------------------------------+
| Coeficientes de variación (CV)    | Variable entre años                | Variable entre años               |
+-----------------------------------+------------------------------------+-----------------------------------+
| CV desembarque                    | 0,2 - 0,1                          | 0,2 - 0,1                         |
+-----------------------------------+------------------------------------+-----------------------------------+
| CV biomasa acústica               | 0,26 - 0,22                        | 0,26 - 0,22                       |
+-----------------------------------+------------------------------------+-----------------------------------+
| nm Flota                          | 15                                 | 15                                |
+-----------------------------------+------------------------------------+-----------------------------------+
| nm crucero                        | 20                                 | 20                                |
+-----------------------------------+------------------------------------+-----------------------------------+

: \label{Tab12} Comparación de estructura, datos, parámetros y supuestos entre el modelo base actual (dinámica a la talla) y mocelo alternativo (dinámica a la edad) de sardina austral Región de Los Lagos.

\normalsize

## 3. RESULTADOS


### 3.1. Matriz de transición de crecimiento talla-talla (Modelo base)

El crecimiento medio es descrito por el modelo von Bertalanffy (VB) puede ser expresado según:

```{=tex}
\begin{equation}
\bar{\Delta_l}=(L\infty-l^*)(1-e^{-k})
\end{equation}
```
Donde, $L\infty$ y $k$ son parámetros de la función VB, $l^*$ corresponde al punto medio del intervalo de talla $l$.

La distribución gamma es utilizada para representar la variación en el crecimiento, ya que permite describir de mejor forma los patrones de crecimiento para peces de tallas muy pequeñas y muy grandes. La distribución gamma puede ser expresada en términos de dos parámetros $\alpha_l$ y $\beta_p$, los cuales se relacionan entre si según:

```{=tex}
\begin{equation}
\alpha_l=\frac{\bar\Delta_l}{\beta_p},
\end{equation}
```
Donde, $\alpha_l$ corresponde a la varianza (es función de $L\infty$ y $k$) proporcional a la media, $\beta_p$ corresponde al coeficiente de variación el que permite incorporar la variabilidad de los individuos en la población. Con ello la proporción de ejemplares que crecen o se mueven de un intervalo a otro queda descrito por:

```{=tex}
\begin{equation}
T_{ll'}=\int^{l'}_l\frac{(l'-l)^a exp(-(l'-l)/\beta_p)}{\beta_p}dl
\end{equation}
```
Donde, $T_{ll'}$ corresponde a la matriz de transición que modela el crecimiento entre $l$ y $l´$ (Sullivan *et al*.,1990). La **Figura 19** muestra la matriz de transición estimada por el modelo base de sardina austral de la Región de Los Lagos.

El reclutamiento se plantea separable en un componente anual y uno talla-específico. $Pr_l$ es el vector de distribución de reclutamiento (ecuación 17). La **Figura 20** muestra el patrón de reclutamiento estimado por el modelo base.

```{=tex}
\begin{equation}
Pr_l=R\int_l^{l+1}\frac{1}{2\pi\sigma^2}exp[-\frac{(l-\mu)^2}{\sigma^2}dl,
\end{equation}
```
Donde, $\mu$ y $\sigma$ corresponden a la media y desviación de una distribución normal constante entre años.

La abundancia $N_{l,t}$ de los ejemplares de talla $l$, a comienzos del año $t$, queda entonces representada por:

```{=tex}
\begin{equation}
N_{l,t}=T_{ll'}N_{l,t-1}exp(-Z_{l,t-1})+Pr_lR_t,
\end{equation}

\begin{equation}
\hat{C}_{l,t}=\frac{F_{l,t}}{Z_{l,t}}N_{l,t}\left(1-S_{l,t}\right)
\end{equation}
```
Donde,$N_{l,t-1}$ corresponde al número de peces de talla $l$, en el año $t-1$, es mortalidad total para peces de talla $l$ en el año $t-1$; $T_{ll}$ es la matriz de transición de crecimiento entre la talla $l$ y $l'$, $Pr_l$ es el vector de distribución de reclutamiento y $R_t$ corresponde al reclutamiento anual. $\hat{C}$ corresponde a la captura en número estimada sobre la base de la estimación de abundancia del número de peces a la talla. La **Figura 21** muestra la estimación de captura en número a la talla estimada por el modelo base, en la cual se evidencia un truncamiento en las tallas sobre los 18 cm, lo cual genera unos picos de abundancia en las tallas de 16 y 17 cm. Y se observa una talla media principal en torno a los 13.5 cm LT.

```{r clave_tallatalla,warning=F, include=T, message=F, echo=FALSE,fig.height=3.5,fig.width=5.5,fig.align="center",fig.path="Figuras/",dev=c('pdf')}
# Clave edad talla --------------------------------------------
# Arreglos
yrs     <- rep0$Years
nyrs    <- length(yrs)
tallas  <- seq(5,19.5,0.5)
ntallas <- length(tallas)
age     <- seq(0,4,1)
nage    <- length(age)

x  <-c(yrs,rev(yrs))
x1 <-c(yrs[1],yrs[nyrs]+1,nyrs+1/2) #xaxp
x2 <-c(yrs[1]-1,yrs[nyrs]+1) #xlim
 
par(mfrow=c(1,1),mar=c(4,4,1,1)+0.5,oma=c(0,0,0,0))
plot(tallas,rep0$MatrizTrans[1,],type="n",las=1, ylim=c(0, 1.2),cex.axis=0.7,cex.lab=0.8,cex.main=0.8, xaxs= "i",yaxs= "i",
ylab="Probabilidad ",xlab="Tallas (cm)",main="Matriz de transición - Modelo base", xaxp=c(3,20,34/2))
for(i in 1:ntallas){lines(tallas,rep0$MatrizTrans[i,]/max(rep0$MatrizTrans[i,]),col=i)}
```

```{=tex}
\vspace{-0.2cm}
\small
\textbf{Figura 19}. Matriz de transición de crecimiento talla a talla
\normalsize
```
```{r patronReclutamiento,warning=F, include=T, message=F, echo=FALSE,fig.height=3.5,fig.width=5.5,fig.align="center",fig.path="Figuras/",dev=c('pdf')}
par(mfrow=c(1,1),mar=c(4,4,1,1)+0.5,oma=c(0,0,0,0))
plot(tallas,rep0$Fun_rec_talla,type="l",ylab="Probabilidad",xlab="Tallas (cm)",main="Patrón de reclutamiento - modelo base",ylim=c(0,0.1),xaxp=c(3,20,34/2),cex.axis=0.7,cex.lab=0.8,cex.main=0.8, xaxs= "i",yaxs= "i",)
 text(exp(2.119)-0.5,0.095,round(exp(2.119)-0.5,1))
```

```{=tex}
\vspace{-0.2cm}
\small
\textbf{Figura 20}. Distribución de probabilidad del reclutamiento
\normalsize
```
```{r AbundanciaTotal_base,eval=T,warning=F, include=T, message=F, echo=FALSE,fig.height=4,fig.width=7,fig.align="center",fig.path="Figuras/",dev=c('pdf')}

tallas     <-seq(5.5,20,0.5)                                            
ntallas    <-length(tallas)    
N          <-rep0$pred_Ctot
year      <-data.0$Ind[,1]
nyear     <-length(year)  

par(mfrow=c(1,1),mar=c(4,4,1,1)+0.5)
plot(tallas,N[1,],type="l",ylab="Captura en número", xlab="Tallas (cm)",ylim=c(0,400),xlim=c(5,20),main="Captura en a la talla - modelo base",xaxp=c(3,20,34/2),cex.lab=0.7,cex.axis=0.7,cex.main=0.7, xaxs= "i",yaxs= "i",)
for(i in 1:19){
  lines(tallas,N[i,],col=i,lwd=2)}
legend(5,400,year,col=1:19,lwd=1,bty="n",cex=0.6)


```

```{=tex}
\vspace{-0.2cm}
\small
\textbf{Figura 21}. Captura en número estimada por el modelo a la talla utilizando la matriz de transición.
\normalsize
```
```{r Comp_Flota_base,warning=F, include=T, message=F,eval=F, echo=FALSE,fig.height=4,fig.width=6,fig.asp=1,fig.align="center",fig.path="Figuras/",dev=c('pdf')}
age     <-seq(5.5,20,0.5)                                            
nage    <-length(age)    
#etf_obs <- data.frame(rep0$Propfl_obs)
etf_obs <- data.frame(rep0$Abundancia_talla)
yearf   <- rep0$Years
nyearf  <-length(yearf)  

 obs  <- as.data.frame(etf_obs) %>% mutate(year=yearf) %>% melt(id.vars='year') %>%
              mutate(edad = rep(age, each=nyearf)) %>% mutate(type='obs')
  mat  <- rbind(obs)
 
  fig1 <- ggplot(filter(mat, type=='obs')) + 
          geom_bar(aes(x = edad, y = value), stat="identity", fill='gray66', color = 'gray28') + 
          facet_wrap(~year, dir = 'v', as.table = TRUE) + 
          labs(title="Modelo base",x = 'Tallas', y = 'Abundancia total') +
          theme(panel.background = element_rect(fill ="gray99")) + 
          theme(panel.grid=element_line(color=NA))
  fig1
  
```

### 3.1.1. Clave talla-edad simulada en modelo alternativo

Dado que el modelo alternativo está basado en una dinámica edad-estructurada, es necesario transformar las estructuras de tallas a edades a través de una clave talla-edad simulada. Esta clave describe la probabilidad de que un individuo de talla $l$ pertenece a una cierta edad $a$. De acuerdo a lo anterior, la proporción de ejemplares de edad $a$ en un intervalo de longitud, $P_{l,a}$ es una función de la longitud promedio ($l_a$) a la edad (predicha por los parámetros de crecimiento) y la varianza ($\sigma_a$) de las longitudes a una edad determinada, según:

```{=tex}
\begin{equation}
l_a = l_{\infty} \left(1-e^k \right) + e^{-k}l_{a-1}
\end{equation}
```
```{=tex}
\begin{equation}
\sigma_a = cv l_a
\end{equation}
```
```{=tex}
\begin{equation}
P_{l,a}(l_a,\sigma_a)=\frac{1}{\sqrt{2\pi\sigma^2_a}}e^{-\frac{\left(l-l_a\right)^2}{2\sigma^2_a}}
\end{equation}
```
donde $P_{l,a}$ representa la matriz de distribución de probabilidad por talla $l$ a la edad $a$. Y $\sigma_a$ corresponde a la desviación estándar de la talla media para la edad $a$. La **Figura 22** muestra la clave talla-edad simulada por el modelo alternativo para obtener las capturas en número estimadas a la talla "l" y año "t".

```{=tex}
\begin{equation}
\hat{C}_{l,t}=P_{l,a}C_{a,t}
\end{equation}
```
Donde $C_{a,t}$ corresponde a las capturas en número observadas a la talla provenientes de los monitoreos de la pesquería y cruceros acústicos. La **Figura 23** muestra las capturas estimadas a la talla utilizando la clave talla-edad antes descrita. Se observan dos modas principales, una en torno a los 9 cm correspondiente al grupo de edad 0 y una segunda moda en torno a los 14 cm. Se observa una bimodalidad más marcada que la captura a la talla estimada por el modelo base (**Figura 21**).

```{r clave_edadtalla,warning=F, include=T, message=F, echo=FALSE,fig.height=3.5,fig.width=6,fig.align="center",fig.path="Figuras/",dev=c('pdf'),eval=TRUE}
# Clave edad talla --------------------------------------------
# Arreglos
yrs     <- rep1$YRS
nyrs    <- length(yrs)
tallas  <- data.1$Tallas
ntallas <- length(tallas)
age     <- data.1$Edades
nage    <- length(age)

x  <-c(yrs,rev(yrs))
x1 <-c(yrs[1],yrs[nyrs]+1,nyrs+1/2) #xaxp
x2 <-c(yrs[1]-1,yrs[nyrs]+1) #xlim

  par(mfrow=c(1,1),mar=c(4,4,1,1)+0.5,oma=c(0,0,0,0))
  plot(tallas,rep1$Prob_talla[1,],type="n",las=1, ylim=c(0, 1.2),cex.lab=0.7,cex.axis=0.7,cex.main=0.8,
       ylab="Probabilidad",xlab="Tallas (cm)",main="Clave talla-edad - modelo alternativo",
       xaxp=c(3,20,34/2), xaxs= "i",yaxs= "i",)
  for(i in 1:nage){lines(tallas,rep1$Prob_talla[i,]/max(rep1$Prob_talla[i,]),col=i)}
  text(round(rep1$mu_edad,1),1.1,round(rep1$mu_edad,0),cex=0.7)
 
```

```{=tex}
\small
\textbf{Figura 22}. Probabilidad de que un individuo de talla "l" pertenece a una cierta edad "a" estimada en el modelo alternativo. Los números sobre cada curva corresponden a la longitud promedio de cada grupo de edad (edades de 0 a 5 años). 
\normalsize
```
```{r AbundanciaTotal_alternativo,eval=T,warning=F, include=T, message=F, echo=FALSE,fig.height=4,fig.width=6,fig.align="center",fig.path="Figuras/",dev=c('pdf')}

tallas     <-seq(5.5,20,0.5)                                            
ntallas    <-length(tallas)    
N          <-rep1$Capt_age
year      <-data.1$Ind[,1]
nyear     <-length(year) 

par(mfrow=c(1,1),mar=c(4,4,1,1)+0.5)
plot(tallas,N[1,],type="l",ylab="Captura en número",xlab="Tallas (cm)",ylim=c(0,400), main="Captura a la talla - modelo alternativo",cex.lab=0.7,cex.axis=0.7,cex.main=0.8,xaxp=c(3,20,34/2), xaxs= "i",yaxs= "i",)
for(i in 1:19){
  lines(tallas,N[i,],col=i,lwd=2)}
legend(6,400,year,col=1:19,lwd=2,bty="n",cex=0.6)
```

```{=tex}
\small
\textbf{Figura 23}. Captura en número estimada por el modelo alternativo utilizando clave talla-edad simulada. \normalsize
```
```{r Comp_Flota_alternativo,warning=F, include=T, message=F,eval=F, echo=FALSE,fig.height=6,fig.width=6,fig.asp=1,fig.align="center",fig.path="Figuras/",dev=c('pdf')}
age     <-seq(5.5,20,0.5)                                            
nage    <-length(age)    
#etf_obs <- data.frame(rep0$Propfl_obs)
etf_obs <- data.frame(rep1$Ntallas)
yearf   <- rep1$YRS
nyearf  <-length(yearf)  

 obs  <- as.data.frame(etf_obs) %>% mutate(year=yearf) %>% melt(id.vars='year') %>%
              mutate(edad = rep(age, each=nyearf)) %>% mutate(type='obs')
 mat  <- rbind(obs)
 
 fig1 <- ggplot(filter(mat, type=='obs')) + 
          geom_bar(aes(x = edad, y = value), stat="identity", fill='gray66', color = 'gray28') + 
          facet_wrap(~year, dir = 'v', as.table = TRUE) + 
          labs(title="Modelo alternativo", x = 'Tallas', y = 'Abundancia total') +
          theme(panel.background = element_rect(fill ="gray99")) + 
          theme(panel.grid=element_line(color=NA))
 fig1
  
```

\pagebreak

### 3.1.2. Comparación del ajuste y residuales del modelo base y alternativo a los datos

Ambos modelos: Modelo base y Modelo alternativo, reproducen la tendencia general de los índices y no parecen mostrar diferencias importantes, excepto en la CPUE, donde el modelo alternativo, parece ajustar de mejor manera algunos años respecto del modelo base actual (**Figura 24**). Esto queda de manifiesto en el análisis de residuos (**Figura 25**). En relación al ajuste del modelo a la información de composiciones de tallas (**Figuras 26 y 27**), se observa que el modelo alternativo parece ser más eficiente en capturar la bimodalidad en la estructura de longitudes observada durante algunos años en la flota y las fuertes modas de los cruceros acústicos. El ajuste del modelo base evidencia un truncamiento en las tallas sobre los 18 cm, lo cual genera unos picos de abundancia en las tallas de 16 y 17 cm en algunos años. Las **Figuras 28 y 29** evidencian un patrón similar en los residuales de las composiciones de tallas de ambos modelos.

### 3.1.3. Comparación del análisis retrospectivo del modelo base y alternativo

En las **Figuras 30 y 31** se muestra los patrones retrospectivos estándar y relativo de la biomasa desovante y mortalidad por pesca para el modelo base y alternativo. En el caso particular de la evaluación de stock de sardina austral de la Región de Los Lagos, la fuerte reducción (por debajo de los niveles promedio) en los índices que conducen el modelo, generó cambios hacia menores valores de R0 (Rmed) a partir del año 2018 (cambio de productividad). Según el actual enfoque de evaluación, el stock debería ser de un tamaño menor, en términos de biomasa y abundancia, que los niveles estimados previo al año 2018. Este cambio genera un conflicto en la estimación de parámetros del modelo base que impide generar estimaciones para los años previos al 2018 considerando los mismos supuestos del caso base actual. El modelo alternativo si permite generar estimaciones para los años previos al 2018 pero evidencia un cambio de productividad al parecer influenciado por la disminución abrupta registrada en los índices del modelo. Para los tres últimos años, ambos modelos muestran una tendencia a subestimar los valores de reclutamientos y biomasa desovante y a sobreestimar los niveles de mortalidad por pesca. Para comprobar la hipótesis de un cambio de productividad es necesario realizar un análisis de posibles cambios demográficos de la población en la zona. Otra hipótesis a evaluar es el efecto de cambios espaciales y/o temporales de la capturabilidad de la flota que se podría estar confundiendo con cambios de productividad de la población. Para corregir posibles errores de proceso del modelo es necesario evaluar estas hipótesis y de esta forma mejorar el patrón retrospectivo observado en ambos modelos de evaluación de stock de sardina austral de la Región de Los Lagos.

### 3.1.4. Comparación de los perfiles de verosimilitud del modelo base y alternativo

Las **Figuras 32 y 33** muestran el perfil de verosimilitud de cada fuente de dato cuyo mínimo representa la estimación máxima a posteriori del reclutamiento medio ($R_0$) para cada fuente de error del modelo base y alternativo. El perfil de la verosimilitud total del modelo base muestra un mínimo en los 4100 aprox, con una tendencia a buscar un segundo mínimo en torno a los 5000. Mientras que el modelo alternativo encuentra un mínimo en torno a los 5000 millones de peces. Para ambos modelos, los datos cuyos perfiles estuvieron más próximos entre si y la diferencia del log verosimilitud respecto del mínimo se elevó por sobre el criterio estadístico $X^2$=1,92 fue la proporción de tallas del crucero (procru), al parecer la proporción de tallas de la flota indicaría un menor nivel de Ro en ambos modelos. Ambos modelos muestran mucho ruido en los perfiles de verosimilitud de los datos de entrada, por lo tanto, es necesario revisar las hipótesis antes señaladas para corregir posibles errores de procesos producto de mala especificación de algunos supuestos empleados.

```{r Ajustes_indices,warning=F, include=T, message=F, echo=FALSE,fig.height=6.5,fig.width=5.5,fig.align="center",fig.path="Figuras/",dev=fig}

library(patchwork)

yrs   <- rep0$Years
nyrs  <- length(yrs)
lasty <- yrs[nyrs]
cvCB   <-data.0$Ind[,7]
cvcpue <-data.0$Ind[,5]
cvdes  <-data.0$Ind[,3]

ind_obs  <- cbind(rep0$Bcru_obs,rep0$CPUE_obs, rep0$Desemb_obs); ind_obs[ind_obs==0] <- NA
colnames(ind_obs) <- c('Biomasa_Crucero', 'CPUE', 'Desembarques') 
ind      <- data.frame(ind_obs) %>% mutate(Asesoría='observado') %>% mutate (yrs= yrs) %>% melt(id.var=c('yrs', 'Asesoría'))  
        
ind_jun <- cbind(c(rep1$reclan_pred), c(rep1$cpue_pred), c(rep1$desemb_pred)) ; 
colnames(ind_jun) <- c('Biomasa_Crucero', 'CPUE', 'Desembarques') 
junio     <- data.frame(ind_jun) %>% mutate (Asesoría='caso alternativo') %>% mutate (yrs= yrs)  %>% melt(id.var=c('yrs', 'Asesoría'))

ind_sept <- cbind(rep0$Bcru_pred, rep0$CPUE_pred, rep0$Desemb_pred) ; 
colnames(ind_sept) <- c('Biomasa_Crucero', 'CPUE', 'Desembarques') 
sept    <- data.frame(ind_sept) %>% mutate (Asesoría='caso base') %>% mutate (yrs= yrs)  %>% melt(id.var=c('yrs', 'Asesoría'))

base1 <- data.frame(rbind(ind, junio, sept))  


f1 <- ggplot(base1 %>% filter(Asesoría!='observado', variable=='Biomasa_Crucero'), 
        aes(yrs,value/1000000)) + geom_line(aes(colour=Asesoría), size=1) +
        scale_colour_manual(values=c('red',"black")) +
        geom_point(data = base1 %>% filter(Asesoría=='observado', variable=='Biomasa_Crucero'),
        aes(yrs,value/1000000), shape = 19, colour = 'gray30') +
        geom_errorbar(data = base1 %>% filter(Asesoría=='observado', variable=='Biomasa_Crucero'),
        aes(ymin = value*exp(-1.96*cvCB)*10^-6, ymax = value*exp(1.96*cvCB)*10^-6), color = 'gray30') +
        scale_x_continuous(breaks = seq(from = 1985, to = 2020, by = 5)) +
        labs(title='Biomasa de Crucero', x = 'Año', y = 'Toneladas (millones)') +
        theme_bw(base_size=9)


f2 <- ggplot(base1 %>% filter(Asesoría!='observado', variable=='CPUE'), 
            aes(yrs,value/1000000)) + geom_line(aes(colour=Asesoría), size=1) +
        scale_colour_manual(values=c('red',"black")) +
        geom_point(data = base1 %>% filter(Asesoría=='observado', variable=='CPUE'),
                   aes(yrs,value/1000000), shape = 19, colour = 'gray30') +
        geom_errorbar(data = base1 %>% filter(Asesoría=='observado', variable=='CPUE'),
                      aes(ymin = value*exp(-1.96*cvcpue)*10^-6, ymax = value*exp(1.96*cvcpue)*10^-6), color = 'gray30') +
        scale_x_continuous(breaks = seq(from = 1985, to = 2020, by = 5)) +
        labs(title='CPUE', x = 'Año', y = 'toneladas/viaje') +
        theme_bw(base_size=9)

f3 <- ggplot(base1 %>% filter(Asesoría!='observado', variable=='Desembarques'), 
            aes(yrs,value/1000)) + geom_line(aes(colour=Asesoría), size=1) +
        scale_colour_manual(values=c('red',"black")) +
        geom_point(data = base1 %>% filter(Asesoría=='observado', variable=='Desembarques'),
                   aes(yrs,value/1000), shape = 19, colour = 'gray30') +
        geom_errorbar(data = base1 %>% filter(Asesoría=='observado', variable=='Desembarques'),
                      aes(ymin = value*exp(-1.96*cvdes)*10^-3, ymax = value*exp(1.96*cvdes)*10^-3), color = 'gray30') +
        scale_x_continuous(breaks = seq(from = 1985, to = 2020, by = 5)) +
        labs(title='Desembarques', x = 'Año', y = 'Toneladas (miles)') +
        theme_bw(base_size=9)

f1/f2/f3 + plot_layout(guides="collect")


```

```{=tex}
\small
\textbf{Figura 24}. Ajuste del modelo base  y alternativo  a los valores de biomasa del crucero, CPUE y desembarques de sardina austral Región de Los Lagos. Las barras corresponden al intervalo de confianza asintótico y el círculo al valor del estimador central. 
\normalsize
\vspace{0.5cm}
```
```{r arreglos_residuales_indices,warning=F, include=T, message=F, echo=FALSE,eval=TRUE}
# Análisis de Residuales Indices  

# Arreglos MAET - MATT
Res_maet <- data.frame(log(ind_obs) - log(ind_jun)) %>% mutate(yrs = yrs) %>% mutate(Asesoría = 'alternativo') 
Res_matt <- data.frame(log(ind_obs) - log(ind_sept)) %>% mutate(yrs = yrs) %>% mutate(Asesoría = 'base')

Res  <- rbind(Res_maet, Res_matt) %>% melt(id.vars= c('yrs','Asesoría'))
pred <- base1 %>% filter(Asesoría!='observado') %>% mutate (pred = log(value)); predm <- pred$pred
Res2 <- cbind(Res,predm)
  

r1<- ggplot(Res, aes(yrs,value)) + 
     geom_bar(aes(fill=Asesoría), stat='identity', position='dodge') +
     scale_fill_manual(values=c("red","black"))+
     geom_hline(yintercept = 0) +
     facet_wrap(. ~ variable,  ncol = 1) + 
     labs(x= 'Año', y = 'Residuales (escala log)') + 
     theme_bw(base_size=12)

r2 <- ggplot(Res2, aes(predm,value)) + 
      geom_point(aes(colour=Asesoría), size = 1.5) +
      scale_colour_manual(values=c('red',"black")) +
      geom_hline(yintercept = 0) +
      facet_wrap(. ~ variable, ncol = 1) +
      labs(x= 'Predicho (log)', y = 'Residuales') +
      theme_bw(base_size=12)

r3 <- ggplot(Res, aes(value, colour=Asesoría)) + 
      geom_histogram(fill='white', position  = 'dodge') +
      facet_wrap(. ~ variable, ncol = 1) + 
      labs(x= 'Residuales', y ='Histograma de Residuos (Frecuencia)') +
      theme_bw(base_size=12)

r4 <-  ggplot(Res, aes(sample = value, colour = Asesoría)) + 
       stat_qq() + 
       stat_qq_line() +
       scale_colour_manual(values=c('red',"black")) +
       facet_wrap(. ~ variable, ncol = 1) + 
       labs(x= 'Sample Quantiles', y ='Theoretical') +
       theme_bw(base_size=12)

```

```{r residuales_indices1,warning=F, include=T, message=F, echo=FALSE,fig.height=11,fig.width=9,fig.align="center",fig.path="Figuras/",dev=c('pdf')}

  r1+r4 + plot_layout(guides="collect")

```

```{=tex}
\small
\textbf{Figura 25}. Análisis de los residuos para cada índice del modelo base  y alternativo  a los valores de biomasa del crucero, CPUE y desembarques de sardina austral Región de Los Lagos.
\normalsize
\vspace{0.5cm}
```
```{r Comp_Flota,warning=F, include=T, message=F, echo=FALSE,fig.height=6,fig.width=6,fig.asp=1,fig.align="center",fig.path="Figuras/",dev=fig}
age     <-seq(5.5,20,0.5)                                            
nage    <-length(age)    
etf_obs <- data.frame(rep0$Propfl_obs)
etf_pre <- rep0$Propfl_pred

etf_obs_alt <- data.frame(rep1$pf_obs)
etf_pre_alt <- rep1$pf_pred

yearf   <- rep0$Years
nyearf  <-length(yearf)  

 obs  <- as.data.frame(etf_obs) %>% mutate(year=yearf) %>% melt(id.vars='year') %>%
              mutate(edad = rep(age, each=nyearf)) %>% mutate(type='obs')
 pred <- as.data.frame(etf_pre) %>% mutate(year=yearf) %>% melt(id.vars='year') %>%
              mutate(edad = rep(age, each=nyearf)) %>% mutate(type='pred')
 
 pred_alt <- as.data.frame(etf_pre_alt) %>% mutate(year=yearf) %>% melt(id.vars='year') %>% mutate(edad = rep(age, each=nyearf)) %>% mutate(type='pred_alt')
  
 mat  <- rbind(obs,pred,pred_alt)
 
 fig1 <- ggplot(filter(mat, type=='obs')) + 
          geom_bar(aes(x = edad, y = value), stat="identity", fill='gray66', color = 'gray28') + 
          facet_wrap(~year, dir = 'v', as.table = TRUE) + labs(x = 'Tallas', y = 'Proporción de tallas de la captura') #, scale='free'
 fig1b <- fig1 + geom_line(data = filter(mat, type=='pred'), aes(x = edad, y = value), color = 'black', size = 1)
 fig1b <- fig1b + geom_line(data = filter(mat, type=='pred_alt'), aes(x = edad, y = value), color = 'red', size = 1)
 
 fig1b + theme(panel.background = element_rect(fill ="gray99")) + theme(panel.grid=element_line(color=NA))
  
```

```{=tex}
\vspace{-0.2cm}
\small
\textbf{Figura 26}. Ajuste del modelo base (línea negra) y alternativo (línea roja) a la estructura de longitud de la flota en la pesquería de sardina austral de la Región de Los Lagos, entre los años 2006 y 2020. Barras (datos observados), líneas negra y roja (modelo ajustado). 
\normalsize
```
\pagebreak

```{r Comp_Crucero,warning=F, include=T, message=F, echo=FALSE,fig.height=7,fig.width=7,fig.asp=1,fig.align="center",fig.path="Figuras/",dev=fig}
age     <-seq(5.5,20,0.5)                                            
nage    <-length(age)    
etc_obs <- data.frame(rep0$Propcru_obs)
etc_pre <- rep0$Propcru_pred

etc_obs_alt <- data.frame(rep1$pobs_RECLAN)
etc_pre_alt <- rep1$ppred_RECLAN

yearc   <- rep0$Years
nyearc  <-length(yearc)  

 obs  <- as.data.frame(etc_obs) %>% mutate(year=yearc) %>% melt(id.vars='year') %>%
              mutate(edad = rep(age, each=nyearc)) %>% mutate(type='obs')
 pred <- as.data.frame(etc_pre) %>% mutate(year=yearc) %>% melt(id.vars='year') %>%
              mutate(edad = rep(age, each=nyearf)) %>% mutate(type='pred')
 
 pred_alt <- as.data.frame(etc_pre_alt) %>% mutate(year=yearc) %>% melt(id.vars='year') %>%
              mutate(edad = rep(age, each=nyearf)) %>% mutate(type='pred_alt')
 
 mat  <- rbind(obs,pred,pred_alt)
 
 fig1 <- ggplot(filter(mat, type=='obs')) + 
          geom_bar(aes(x = edad, y = value), stat="identity", fill='gray66', color = 'gray28') + 
          facet_wrap(~year, dir = 'v', as.table = TRUE) + labs(x = 'Tallas', y = 'Proporción de tallas del Crucero') #, scale='free'
 fig1b <- fig1 + geom_line(data = filter(mat, type=='pred'), aes(x = edad, y = value),color = 'black', size = 1)
 fig1b <- fig1b + geom_line(data = filter(mat, type=='pred_alt'), aes(x = edad, y = value),color = 'red', size = 1)
 fig1b + theme(panel.background = element_rect(fill ="gray99")) + theme(panel.grid=element_line(color=NA))
 
```

```{=tex}
\vspace{-0.2cm}
\small
\textbf{Figura 27}. Ajuste del modelo base (línea negra) y alternativo (línea roja) a la estructura de longitud del crucero de evaluación hidroacústica de sardina austral de la Región de Los Lagos. Barras (datos observados), líneas negra y roja (modelo ajustado). 
\normalsize
\vspace{0.5cm}
```
```{r Residuos_comp, warning=F, include=T, message=F, echo=FALSE,fig.height=5,fig.width=8,fig.align="center",fig.path="Figuras/",dev=fig}
par(mfcol=c(1,2))
cx<-0.7
#Flota
#modelo base
age     <-seq(5.5,20,0.5)                                            
nage    <-length(age)  
anos    <-rep0$Years
obsF    <-rep0$Propfl_obs
preF    <-rep0$Propfl_pred
resF    <-obsF-preF

rng <-range(resF,na.rm=T)
dd  <-dim(resF)
est <-matrix(NA,nrow=dd[1],ncol=dd[2])

for(j in 1:dd[1]){for(k in 1:dd[2]){val<-resF[j,k]
if(val>0){est[j,k]<-val/rng[2]}
else{est[j,k]<-val/rng[1]*-1}}}

par(mar=c(5.4,6.7,2,1),cex.axis=cx,cex.lab=cx)
image(age,anos,t(est),col=0,yaxt="n",xlab="",ylab="")
ee  <-dim(est)
for(n in 1:ee[1]){for(m in 1:ee[2]){vol<-est[n,m]
if(is.na(vol)==FALSE){
	if(vol>0){points(age[m],anos[n],pch=19,cex=2*sqrt(vol),col=1)}
	if(vol<0){points(age[m],anos[n],pch=1,cex=2*sqrt(vol*-1),col=1)}
}}}

mtext("Flota - base",side=3,cex=cx)
mtext("Tallas (cm)",side=1,line=3.2,cex=cx);posi<-seq(1,57,by=4)
axis(2,at=anos,labels=anos,las=2,cex=cx)
mtext("Años",side=2,line=4.7,cex=cx)
box()

#Crucero base
age  <-seq(5.5,20,0.5)                                            
nage <-length(age) 
anos <-rep0$Years
obsB <-rep0$Propcru_obs
preB <-rep0$Propcru_pred
resB <-obsB-preB

rng <-range(resB,na.rm=T)
dd  <-dim(resB)
est <-matrix(NA,nrow=dd[1],ncol=dd[2])

for(j in 1:dd[1]){for(k in 1:dd[2]){val<-resB[j,k]
if(val>0){est[j,k]<-val/rng[2]}
else{est[j,k]<-val/rng[1]*-1}}}

par(mar=c(5.4,6.7,2,1),cex.axis=cx,cex.lab=cx)
image(age,anos,t(est),col=0,yaxt="n",xlab="",ylab="")
ee  <-dim(est)
for(n in 1:ee[1]){for(m in 1:ee[2]){vol<-est[n,m]
if(is.na(vol)==FALSE){
	if(vol>0){points(age[m],anos[n],pch=19,cex=2*sqrt(vol),col=1)}
	if(vol<0){points(age[m],anos[n],pch=1,cex=2*sqrt(vol*-1),col=1)}
}}}
mtext("Crucero Acústico - base",side=3,cex=cx)
mtext("Tallas (cm)",side=1,line=3.2,cex=cx);posi<-seq(1,57,by=4)
axis(2,at=anos,labels=anos,las=2,cex=cx)
mtext("Años",side=2,line=4.7,cex=cx)
box()
```

```{=tex}
\vspace{-0.2cm}
\small
\textbf{Figura 28}. Residuales de las estructuras de tallas de la flota y cruceros. Subestimaciones (círculos negros) y sobreestimaciones (circulo blanco). El tamaño del globo indica la magnitud relativa del error por tallas. \textbf{Modelo base}.
\normalsize
```
```{r Residuos_comp_alternaitvos, warning=F, include=T, message=F, echo=FALSE,fig.height=5,fig.width=8,fig.align="center",fig.path="Figuras/",dev=fig}
par(mfcol=c(1,2))
#Flota
cx<-0.7
# modelo alternativo
obsF_alt    <-rep1$pf_obs
preF_alt    <-rep1$pf_pred
resF_alt    <-obsF_alt-preF_alt

rng <-range(resF_alt,na.rm=T)
dd  <-dim(resF_alt)
est <-matrix(NA,nrow=dd[1],ncol=dd[2])

for(j in 1:dd[1]){for(k in 1:dd[2]){val<-resF_alt[j,k]
if(val>0){est[j,k]<-val/rng[2]}
else{est[j,k]<-val/rng[1]*-1}}}

par(mar=c(5.4,6.7,2,1),cex.axis=cx,cex.lab=cx)
image(age,anos,t(est),col=0,yaxt="n",xlab="",ylab="")
ee  <-dim(est)
for(n in 1:ee[1]){for(m in 1:ee[2]){vol<-est[n,m]
if(is.na(vol)==FALSE){
	if(vol>0){points(age[m],anos[n],pch=19,cex=2*sqrt(vol),col=2)}
	if(vol<0){points(age[m],anos[n],pch=1,cex=2*sqrt(vol*-1),col=2)}
}}}

mtext("Flota - alternativo",side=3,cex=cx)
mtext("Tallas (cm)",side=1,line=3.2,cex=cx);posi<-seq(1,57,by=4)
axis(2,at=anos,labels=anos,las=2,cex=cx)
mtext("Años",side=2,line=4.7,cex=cx)
box()

#Crucero alternativo

obsB_alt <-rep1$pobs_RECLAN
preB_alt <-rep1$ppred_RECLAN
resB_alt <-obsB_alt-preB_alt

rng <-range(resB_alt,na.rm=T)
dd  <-dim(resB_alt)
est <-matrix(NA,nrow=dd[1],ncol=dd[2])

for(j in 1:dd[1]){for(k in 1:dd[2]){val<-resB_alt[j,k]
if(val>0){est[j,k]<-val/rng[2]}
else{est[j,k]<-val/rng[1]*-1}}}

par(mar=c(5.4,6.7,2,1),cex.axis=cx,cex.lab=cx)
image(age,anos,t(est),col=0,yaxt="n",xlab="",ylab="")
ee  <-dim(est)
for(n in 1:ee[1]){for(m in 1:ee[2]){vol<-est[n,m]
if(is.na(vol)==FALSE){
	if(vol>0){points(age[m],anos[n],pch=19,cex=2*sqrt(vol),col=2)}
	if(vol<0){points(age[m],anos[n],pch=1,cex=2*sqrt(vol*-1),col=2)}
}}}
mtext("Crucero Acústico - alternativo",side=3,cex=cx)
mtext("Tallas (cm)",side=1,line=3.2,cex=cx);posi<-seq(1,57,by=4)
axis(2,at=anos,labels=anos,las=2,cex=cx)
mtext("Años",side=2,line=4.7,cex=cx)
box()

```

```{=tex}
\vspace{-0.2cm}
\small
\textbf{Figura 29}. Residuales de las estructuras de tallas de la flota y cruceros. Subestimaciones (círculos rojos) y sobreestimaciones (circulo blanco). El tamaño del globo indica la magnitud relativa del error por tallas. \textbf{Modelo alternativo}.
\normalsize
```
\pagebreak

```{r Variablesbase_std, echo=F,message=FALSE, warning=FALSE, include=T}

years<-rep0$Years
nyears<-length(years)

Rt1      <- subset(std0,name=="Reclutas")$value 
Rt1std   <- subset(std0,name=="Reclutas")$std
BT1      <- subset(std0,name=="BT")$value   
BT1std   <- subset(std0,name=="BT")$std
BD1      <- subset(std0,name=="BD")$value   
BD1std   <- subset(std0,name=="BD")$std
Ft1      <- subset(std0,name=="log_F")$value   
Ft1std   <- subset(std0,name=="log_F")$std

VarPob<- data.frame(x=years, Rt1=Rt1,BT1=BT1,BD1=BD1,Ft1=exp(Ft1), 
         lowerRt1 = (Rt1 -1.96*Rt1std), upperRt1 = (Rt1+1.96*Rt1std),
         lowerBT1 = (BT1 -1.96*BT1std), upperBT1 = (BT1+1.96*BT1std),
         lowerBD1 = (BD1 -1.96*BD1std), upperBD1 = (BD1+1.96*BD1std),
         lowerFt1 = exp(Ft1 -1.96*Ft1std), upperFt1 = exp(Ft1+1.96*Ft1std))

```

```{r Dat_Retrospectivobase, eval=F,echo=F, message=FALSE, warning=FALSE, include=T}
dir<-paste(dir.0,"/Retrospectivobase",sep="")
setwd(dir)
admb<-"MTT0920"

years<-rep0$Years
nyears<-length(years)
retros<-seq(1,3)
nretros<-length(retros)
year_retros<-as.factor(years[(nyears-(nretros-1)):nyears])
                      
retroR      <- matrix(0,nrow=nyears,ncol=nretros+1)
retroBD     <- matrix(0,nrow=nyears,ncol=nretros+1)
retroF      <- matrix(0,nrow=nyears,ncol=nretros+1)

for(i in 1:length(retros)){
  rep<- reptoRlist(paste(admb,"s",i,".rep",sep=""))
  retroR[,i+1] <- c(rep$Reclutamiento,rep(NA,i-1))
  retroBD[,i+1] <- c(rep$Biomasa_desovante,rep(NA,i-1))
  retroF[,i+1]  <- c(rep$F,rep(NA,i-1)) }


# retrospectivo relativo (cálculo)
    mohn.r       <- rep(NA, nretros)
    rel.diff.r   <- matrix(NA, nrow=nyears, ncol=(nretros))
    mohn.ssb     <- rep(NA, nretros)
    rel.diff.ssb <- matrix(NA, nrow=nyears, ncol=(nretros))
    mohn.f       <- rep(NA, nretros)
    rel.diff.f   <- matrix(NA, nrow=nyears, ncol=(nretros))

    for(j in 1:nretros){
      rel.diff.r[,j] <- (retroR[,(j+1)]-retroR[,2])/retroR[,2]
      mohn.r[j]      <- rel.diff.r[(nyears-j),j]
      rel.diff.ssb[,j] <- (retroBD[,(j+1)]-retroBD[,2])/retroBD[,2]
      mohn.ssb[j]      <- rel.diff.ssb[(nyears-j),j]
      rel.diff.f[,j]   <- (retroF[,(j+1)]-retroF[,2])/retroF[,2]
      mohn.f[j]        <- rel.diff.f[(nyears-j),j]}
    
    ave.mohn.r    <- mean(mohn.r)
    ave.mohn.ssb  <- mean(mohn.ssb)
    ave.mohn.f    <- mean(mohn.f)
    
 # Arreglo datos

#Para retrospectivo tradicional
Rt_retro<- data.frame(x=years, y1=retroR[,2],y2=retroR[,3],y3=retroR[,4],
                      lower = (Rt1 -1.96*Rt1std), upper = (Rt1+1.96*Rt1std))
BD_retro<- data.frame(x=years, y1=retroBD[,2],y2=retroBD[,3],y3=retroBD[,4],
                      lower = (BD1 -1.96*BD1std), upper = (BD1+1.96*BD1std))
Ft_retro<- data.frame(x=years, y1=retroF[,2],y2=retroF[,3],y3=retroF[,4], 
                      lower = exp(Ft1-1.96*Ft1std), upper = exp(Ft1+1.96*Ft1std))

#Para restrospectivo relativo
Rt_retroRel<- data.frame(x=years, y1=rel.diff.r[,1],y2=rel.diff.r[,2],y3=rel.diff.r[,3])
BD_retroRel<- data.frame(x=years, y1=rel.diff.ssb[,1],y2=rel.diff.ssb[,2],y3=rel.diff.ssb[,3])
Ft_retroRel<- data.frame(x=years, y1=rel.diff.f[,1],y2=rel.diff.f[,2],y3=rel.diff.f[,3])

```

```{r F33_retrospectivo_base, eval=F,echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.height=10, fig.width=8,fig.path=dir.Fig,dev=fig}

#Retrospectivo tradicional
Rt <- ggplot(Rt_retro) + 
    geom_ribbon(aes(ymin=lower, ymax=upper, x=x, fill = "IC asintótico"), alpha = 0.2)+
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    labs(x = '', y = 'Reclutamientos ',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1995, to = 2020, by = 2)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top")

BD <- ggplot(BD_retro) + 
     geom_ribbon(aes(ymin=lower, ymax=upper, x=x, fill = ""), alpha = 0.2)+
     geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    labs(x = '', y = 'Biomasa desovante (t)',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1995, to = 2020, by = 2)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Ft <- ggplot(Ft_retro) + 
    geom_ribbon(aes(ymin=lower, ymax=upper, x=x, fill = ""), alpha = 0.2)+
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    labs(x = '', y = 'Mortalidad por pesca (F)',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1995, to = 2020, by = 2)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
    ggtitle('')+
    theme(plot.title = element_text(hjust = 0.5),legend.position="none")

#Retrospectivo relativo
Rtrel <- ggplot(Rt_retroRel) + lims(y=c(-1,1)) +
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
   annotate("text", x=2004, y=0.75,label=paste("Rho =",round(ave.mohn.r,2))) +
    labs(x = '', y = 'Diferencia porcentual del último año',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1995, to = 2020, by = 2)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

BDrel <- ggplot(BD_retroRel) + lims(y=c(-1,1)) +
     geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
   annotate("text", x=2004, y=0.75,label=paste("Rho =",round(ave.mohn.ssb,2))) +
    labs(x = '', y = 'Diferencia porcentual del último año',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1995, to = 2020, by = 2)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Ftrel <- ggplot(Ft_retroRel) + lims(y=c(-1,1)) +
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
   annotate("text", x=2004, y=0.75,label=paste("Rho =",round(ave.mohn.f,2))) +
    labs(x = '', y = 'Diferencia porcentual del último año',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1995, to = 2020, by = 2)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
    ggtitle('')+
    theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Rt/BD/Ft |Rtrel/BDrel/Ftrel

```

```{=tex}
\vspace{-0.2cm}
\small
\textbf{Figura 30}. Patrón retrospectivo estándar (panel izquierdo) y relativo (panel derecho) de los reclutamientos, biomasa desovante y de la mortalidad por pesca de sardina austral de la Región de Los Lagos. \textbf{Modelo base}.
\normalsize
```
```{r Variablesalternativo_std, echo=F,message=FALSE, warning=FALSE, include=T}

years<-rep1$YRS
nyears<-length(years)

Rt2      <- subset(std1,name=="Reclutas")$value 
Rt2std   <- subset(std1,name=="Reclutas")$std
BT2      <- subset(std1,name=="BT")$value   
BT2std   <- subset(std1,name=="BT")$std
BD2      <- subset(std1,name=="BD")$value   
BD2std   <- subset(std1,name=="BD")$std
Ft2      <- subset(std1,name=="log_F")$value   
Ft2std   <- subset(std1,name=="log_F")$std

VarPob<- data.frame(x=years, Rt2=Rt2,BT2=BT2,BD2=BD2,Ft2=exp(Ft2), 
         lowerRt2 = (Rt2 -1.96*Rt2std), upperRt2 = (Rt2+1.96*Rt2std),
         lowerBT2 = (BT2 -1.96*BT2std), upperBT2 = (BT2+1.96*BT2std),
         lowerBD2 = (BD2 -1.96*BD2std), upperBD2 = (BD2+1.96*BD2std),
         lowerFt2 = exp(Ft2 -1.96*Ft2std), upperFt2 = exp(Ft2+1.96*Ft2std))

```

```{r Dat_Retrospectivoalternativo, eval=F,echo=F, message=FALSE, warning=FALSE, include=T}
dir<-paste(dir.0,"/Retrospectivoalternativo",sep="")
setwd(dir)
admb<-"MAT0920"

years<-rep1$YRS
nyears<-length(years)
retros<-seq(1,5)
nretros<-length(retros)
year_retros<-as.factor(years[(nyears-(nretros-1)):nyears])
                      
retroR      <- matrix(0,nrow=nyears,ncol=nretros+1)
retroBD     <- matrix(0,nrow=nyears,ncol=nretros+1)
retroF      <- matrix(0,nrow=nyears,ncol=nretros+1)

for(i in 1:length(retros)){
  rep<- reptoRlist(paste(admb,"s",i,".rep",sep=""))
  retroR[,i+1] <- c(rep$Reclutas,rep(NA,i-1))
  retroBD[,i+1] <- c(rep$BD,rep(NA,i-1))
  retroF[,i+1]  <- c(rep$F,rep(NA,i-1)) }


# retrospectivo relativo (cálculo)
    mohn.r       <- rep(NA, nretros)
    rel.diff.r   <- matrix(NA, nrow=nyears, ncol=(nretros))
    mohn.ssb     <- rep(NA, nretros)
    rel.diff.ssb <- matrix(NA, nrow=nyears, ncol=(nretros))
    mohn.f       <- rep(NA, nretros)
    rel.diff.f   <- matrix(NA, nrow=nyears, ncol=(nretros))

    for(j in 1:nretros){
      rel.diff.r[,j] <- (retroR[,(j+1)]-retroR[,2])/retroR[,2]
      mohn.r[j]      <- rel.diff.r[(nyears-j),j]
      rel.diff.ssb[,j] <- (retroBD[,(j+1)]-retroBD[,2])/retroBD[,2]
      mohn.ssb[j]      <- rel.diff.ssb[(nyears-j),j]
      rel.diff.f[,j]   <- (retroF[,(j+1)]-retroF[,2])/retroF[,2]
      mohn.f[j]        <- rel.diff.f[(nyears-j),j]}
    
    ave.mohn.r    <- mean(mohn.r)
    ave.mohn.ssb  <- mean(mohn.ssb)
    ave.mohn.f    <- mean(mohn.f)
    
 # Arreglo datos

#Para retrospectivo tradicional
Rt_retro<- data.frame(x=years, y1=retroR[,2],y2=retroR[,3],y3=retroR[,4],y4=retroR[,5],y5=retroR[,6],
                      lower = (Rt2 -1.96*Rt2std), upper = (Rt2+1.96*Rt2std))
BD_retro<- data.frame(x=years, y1=retroBD[,2],y2=retroBD[,3],y3=retroBD[,4],y4=retroBD[,5],y5=retroBD[,6],
                      lower = (BD2 -1.96*BD2std), upper = (BD2+1.96*BD2std))
Ft_retro<- data.frame(x=years, y1=retroF[,2],y2=retroF[,3],y3=retroF[,4],y4=retroF[,5],y5=retroF[,6], 
                      lower = exp(Ft2-1.96*Ft2std), upper = exp(Ft2+1.96*Ft2std))

#Para restrospectivo relativo
Rt_retroRel<- data.frame(x=years, y1=rel.diff.r[,1],y2=rel.diff.r[,2],y3=rel.diff.r[,3],y4=rel.diff.r[,4],y5=rel.diff.r[,5])
BD_retroRel<- data.frame(x=years, y1=rel.diff.ssb[,1],y2=rel.diff.ssb[,2],y3=rel.diff.ssb[,3],y4=rel.diff.ssb[,4],y5=rel.diff.ssb[,5])
Ft_retroRel<- data.frame(x=years, y1=rel.diff.f[,1],y2=rel.diff.f[,2],y3=rel.diff.f[,3],y4=rel.diff.f[,4],y5=rel.diff.f[,5])

```

```{r F33_retrospectivo_alternativo, eval=F,echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.height=10, fig.width=8,fig.path=dir.Fig,dev=fig}

#Retrospectivo tradicional
Rt <- ggplot(Rt_retro) + 
    geom_ribbon(aes(ymin=lower, ymax=upper, x=x, fill = "IC asintótico"), alpha = 0.2)+
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
    labs(x = '', y = 'Reclutamientos ',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1995, to = 2020, by = 2)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="top")

BD <- ggplot(BD_retro) + 
     geom_ribbon(aes(ymin=lower, ymax=upper, x=x, fill = ""), alpha = 0.2)+
     geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
    labs(x = '', y = 'Biomasa desovante (t)',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1995, to = 2020, by = 2)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Ft <- ggplot(Ft_retro) + 
    geom_ribbon(aes(ymin=lower, ymax=upper, x=x, fill = ""), alpha = 0.2)+
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
    labs(x = '', y = 'Mortalidad por pesca (F)',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1995, to = 2020, by = 2)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
    ggtitle('')+
    theme(plot.title = element_text(hjust = 0.5),legend.position="none")

#Retrospectivo relativo
Rtrel <- ggplot(Rt_retroRel) + lims(y=c(-1,1)) +
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
   annotate("text", x=2004, y=0.75,label=paste("Rho =",round(ave.mohn.r,2))) +
    labs(x = '', y = 'Diferencia porcentual del último año',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1995, to = 2020, by = 2)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

BDrel <- ggplot(BD_retroRel) + lims(y=c(-1,1)) +
     geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
   annotate("text", x=2004, y=0.75,label=paste("Rho =",round(ave.mohn.ssb,2))) +
    labs(x = '', y = 'Diferencia porcentual del último año',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1995, to = 2020, by = 2)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
     ggtitle('')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Ftrel <- ggplot(Ft_retroRel) + lims(y=c(-1,1)) +
    geom_line(aes(y=y1, x=x, colour = year_retros[nretros]), size=0.5)+
    geom_line(aes(y=y2, x=x, colour = year_retros[nretros-1]), size=0.5)+
    geom_line(aes(y=y3, x=x, colour = year_retros[nretros-2]), size=0.5)+
    geom_line(aes(y=y4, x=x, colour = year_retros[nretros-3]), size=0.5)+
    geom_line(aes(y=y5, x=x, colour = year_retros[nretros-4]), size=0.5)+
   annotate("text", x=2004, y=0.75,label=paste("Rho =",round(ave.mohn.f,2))) +
    labs(x = '', y = 'Diferencia porcentual del último año',colour='Asesorías')  +
    scale_x_continuous(breaks = seq(from = 1995, to = 2020, by = 2)) +
    scale_colour_manual("",values=c("orange","green","blue","red","black"))+
    scale_fill_manual("",values=c("grey30"))+
    theme_bw(base_size=8) +
    ggtitle('')+
    theme(plot.title = element_text(hjust = 0.5),legend.position="none")

Rt/BD/Ft |Rtrel/BDrel/Ftrel

```

```{=tex}
\vspace{-0.5cm}
\small
\textbf{Figura 31}. Patrón retrospectivo estándar (panel izquierdo) y relativo (panel derecho) de los reclutamientos, biomasa desovante y de la mortalidad por pesca de sardina austral de la Región de Los Lagos. \textbf{Modelo alternativo}.
\normalsize
```
\pagebreak

```{r F_verosimilitud_base, eval=F, echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.height=4, fig.width=5,fig.path=dir.Fig,dev=fig}

admb<-"MTT0920"
setwd(dir.5)
  casos <-35
  logRo    <- rep(0,casos)
  likeval  <- matrix(ncol=9,nrow=casos)
  slikeval <- matrix(ncol=10,nrow=casos)
  
  for(i in 1:casos){
    rep         <- reptoRlist(paste(admb,"s",i,".rep",sep=""))
    data        <- readLines(paste(admb,"s",i,".dat", sep=''),encoding="UTF-8")
    logRo[i]    <- as.numeric(data[159])
    likeval[i,] <- rep$Likeval}
  #===========================================================================================================
  # SEXTO PASO: ESTANDARIZAR VEROSIMILITUD
  #===========================================================================================================
  like    <- data.frame(round(likeval,3),Total=apply(likeval,1,sum))
  minLik  <- apply(like,2,min)                         # busca el minimo
  for(i in 1:10){slikeval[,i]<-like[,i]-minLik[i]}    # Estandarizaci?n
  #===========================================================================================================
  # ULTIMO PASO: GUARDAR TABLAS Y FIGURA
  #===========================================================================================================
  #CPUE   BCru   Bmph   Desemb  pfFlota  pfCru  dev_R  devNo LR
  names<-c("Ro","cpue",	"cru","mph", 	"desemb",	"proflo",	"procru",	
           "desvRo",	"desNo",	"Lo", "Total")
  # Tabla verosimilitud
  TLk1 <- data.frame(exp(logRo),like);
  colnames(TLk1)<-names
  # Tabla estandarizada
  TLk2 <- data.frame(exp(logRo),slikeval);
  colnames(TLk2)<-names
  
  par(mar=c(4,4,1,1)+0.5)
  plot(TLk2$Ro,TLk2$Total,type="l",lwd=3,ylim=c(0,4),xlim=c(2500,8000), xaxs= "i",yaxs= "i",
       ylab="L-min(L)",xlab="Ro",   las=1,main="Modelo base",cex.main=0.7,cex.axis=0.7,cex.lab=0.7)
  abline(h=2,col=1,lty=2)
   for(i in 2:7){lines(TLk2$Ro,TLk2[,i],col=i,lty=2,lwd=2)}
   legend(6000,4,names[c(11,2:7)],col=1:8,lty=c(1,rep(2,7)),lwd=2,bty="n",cex=0.8)
```

```{=tex}
\vspace{-0.5cm}
\small
\textbf{Figura 32}. Perfil de verosimilitud donde la línea horizontal representa el nivel crítico para el test $X^2$. \textbf{Modelo base}. 
\normalsize
```
```{r F_verosimilitud_alternativo,eval=F, echo=FALSE, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.height=4, fig.width=5,fig.path=dir.Fig,dev=fig}

admb<-"MAT0920"
setwd(dir.4)
  casos <-35
  logRo    <- rep(0,casos)
  likeval  <- matrix(ncol=9,nrow=casos)
  slikeval <- matrix(ncol=10,nrow=casos)
  
  for(i in 1:casos){
    rep         <- reptoRlist(paste(admb,"s",i,".rep",sep=""))
    data        <- readLines(paste(admb,"s",i,".dat", sep=''),encoding="UTF-8")
    logRo[i]    <- as.numeric(data[151])
    likeval[i,] <- rep$likeval}
  #===========================================================================================================
  # SEXTO PASO: ESTANDARIZAR VEROSIMILITUD
  #===========================================================================================================
  like    <- data.frame(round(likeval,3),Total=apply(likeval,1,sum))
  minLik  <- apply(like,2,min)                         # busca el minimo
  for(i in 1:10){slikeval[,i]<-like[,i]-minLik[i]}    # Estandarizaci?n
  #===========================================================================================================
  # ULTIMO PASO: GUARDAR TABLAS Y FIGURA
  #===========================================================================================================
  #CPUE   BCru   Bmph   Desemb  pfFlota  pfCru  dev_R  devNo LR
  names<-c("Ro","cpue",	"cru", "desemb",	"proflo",	"procru",	
           "desvRo",	"desNo",	"Lo", "","Total")
  # Tabla verosimilitud
  TLk1 <- data.frame(exp(logRo),like);
  colnames(TLk1)<-names
  # Tabla estandarizada
  TLk2 <- data.frame(exp(logRo),slikeval);
  colnames(TLk2)<-names
  
  par(mar=c(4,4,1,1)+0.5)
  plot(TLk2$Ro,TLk2$Total,type="l",lwd=3,ylim=c(0,4),xlim=c(2500,8000), xaxs= "i",yaxs= "i",
       ylab="L-min(L)",xlab="Ro",   las=1,main="Modelo alternativo",cex.main=0.7,cex.axis=0.7,cex.lab=0.7)
  abline(h=2,col=1,lty=2)
   for(i in 2:6){lines(TLk2$Ro,TLk2[,i],col=i,lty=2,lwd=2)}
   legend(4000,4,names[c(11,2:6)],col=1:7,lty=c(1,rep(2,6)),lwd=2,bty="n",cex=0.8)
```

```{=tex}
\vspace{-0.5cm}
\small
\textbf{Figura 33}. Perfil de verosimilitud donde la línea horizontal representa el nivel crítico para el test $X^2$. \textbf{Modelo alternativo}. 
\normalsize
```
\pagebreak

### 3.1.5. Comparación de las tendencias poblacionales del modelo base y alternativo

La **Figura 34** muestra las estimaciones de las variables poblacionales de biomasa, reclutamientos y mortalidad por pesca obtenidas por el modelo base y alternativo. No se observan diferencias significativas entre ambos modelos, generando las mismas tendencias y magnitudes poblacionales. Las principales diferencias se observan en la estimación de la mortalidad por pesca, donde el modelo alternativo presenta mayor variabilidad interanual que el modelo base. La **Figura 35** muestra el patrón de explotación estimado a la talla por el modelo base y estimado a la edad por el modelo alternativo. En el caso del modelo base se consideran tres bloques de selectividad cuyo objetivo fue predicir de mejor manera la variabilidad y bimodalidad en las estructuras de tallas, aunque sin mejoras importantes en los ajustes en las estructuras de longitudes de la flota y crucero. El modelo alternativo no reconoce cambios en la selectividad de la flota aunque se utilice el mismo supuesto de bloques del modelo base. Mientras que la selectividad del crucero ambos modelos estiman cambios en la selectividad a partir del año 2013.

```{r calculo_PBRs_base,warning=F, include=T, message=F, echo=FALSE}

Tsard<- read.table(paste(dir.0,"/funciones/T0918.txt",sep=""),sep="",na="NA",fill=T) #se debe actualizar esto???
# Probar 3 bloques de selectividad

nyears0 <- length(rep0$Years)
Dat        <- list()
Dat$M  	  <- 0.83
Dat$Tspw	<- 0.58
Dat$Mad	  <- data.0$Madurez
Dat$Sel	  <- rep0$Selflo_talla[nyears0,] #bloque 1=[1,], bloque 2=[9,], bloque 3=[19,]
Dat$Wmed	<- data.0$Pesos_medios
Dat$Pre   <- rep0$Fun_rec_talla
Ta        <- as.matrix(Tsard)
talla  	  <- data.0$Tallas
edad      <- seq(0,4,1)
Fmort 	  <- seq(0,3,0.01)      
R0 		    <- 1

source(paste(dir.0,"/funciones/Fun_Pbrs.R",sep=""))
PBRs <- SPRFmort(R0,Fmort,talla,edad,Dat) 
FRMS<-subset(PBRs,PBRs[,4]==0.60)[1]

#Pbrs modelo base
#B0 <- Bmed/pB_Fmh
BDo <- rep0$BD_virgen_LP
# Paso 5: Obtenci?n de Bmrs
BRMS <- BDo*0.55
# Paso 6: Obtrencion de Blim
BDlim<- BDo*0.275

Pbrs<-rbind(BDo,BRMS,BDlim,FRMS)

#PBRs modelo alternativo
#B0 <- Bmed/pB_Fmh
BDo0 <- rep1$Bo
# Paso 5: Obtenci?n de Bmrs
BRMS0 <- BDo0*0.55
# Paso 6: Obtrencion de Blim
BDlim0<- BDo0*0.275
FRMS0<-exp(subset(std1,name=="log_Fref")$value[1])
Pbrs0<-rbind(BDo0,BRMS0,BDlim0,FRMS0)

```

```{r DatosVariables_poblacionales,warning=F, include=T, message=F, echo=FALSE}

years0  <- rep0$Years; nyears0 <- length(years0)                                                      
x0      <-c(years0,rev(years0))
x0_1    <-c(2000,2021,21) #xaxp

#modelo base
Ro0            <- subset(std0,name=="log_Rmed")$value
Reclutas0     <- subset(std0,name=="Reclutas")$value
Reclutas0std  <- subset(std0,name=="Reclutas")$std
logdesvRt0    <- subset(std0,name=="log_desv_Rt")$value
logdesvRt0std <- subset(std0,name=="log_desv_Rt")$std
Bt0           <- subset(std0,name=="BT")$value
Bt0std        <- subset(std0,name=="BT")$std
SSBt0         <- subset(std0,name=="BD")$value
SSBt0std      <- subset(std0,name=="BD")$std
Ft0           <- subset(std0,name=="log_F")$value
Ft0std        <- subset(std0,name=="log_F")$std

#arreglos polígono
rt0      <- c((Reclutas0-1.96*Reclutas0std),rev(Reclutas0+1.96*Reclutas0std))
logdrt0  <- c((logdesvRt0-1.96*logdesvRt0std),rev(logdesvRt0+1.96*logdesvRt0std))
bt0    <- c((Bt0-1.96*Bt0std),rev((Bt0+1.96*Bt0std)))
ssbt0    <- c((SSBt0-1.96*SSBt0std),rev((SSBt0+1.96*SSBt0std)))
ft0      <- c(exp((Ft0)-1.96*(Ft0std)),rev(exp((Ft0)+1.96*(Ft0std)))) 

#modelo alternativo
Ro1            <- subset(std1,name=="log_Ro")$value
Reclutas1     <- subset(std1,name=="Reclutas")$value
Reclutas1std  <- subset(std1,name=="Reclutas")$std
logdesvRt1    <- subset(std1,name=="log_desv_Rt")$value
logdesvRt1std <- subset(std1,name=="log_desv_Rt")$std
Bt1           <- subset(std1,name=="BT")$value
Bt1std        <- subset(std1,name=="BT")$std
SSBt1         <- subset(std1,name=="BD")$value
SSBt1std      <- subset(std1,name=="BD")$std
Ft1           <- subset(std1,name=="log_F")$value
Ft1std        <- subset(std1,name=="log_F")$std

#arreglos polígono
rt1      <- c((Reclutas1-1.96*Reclutas1std),rev(Reclutas1+1.96*Reclutas1std))
logdrt1  <- c((logdesvRt1-1.96*logdesvRt1std),rev(logdesvRt1+1.96*logdesvRt1std))
bt1      <- c((Bt1-1.96*Bt1std),rev((Bt1+1.96*Bt1std)))
ssbt1    <- c((SSBt1-1.96*SSBt1std),rev((SSBt1+1.96*SSBt1std)))
ft1      <- c(exp((Ft1)-1.96*(Ft1std)),rev(exp((Ft1)+1.96*(Ft1std)))) 

```

```{r Variables_poblacionales,warning=F, include=T, message=F, echo=FALSE,fig.height=8,fig.width=10,fig.align="center",fig.path="Figuras/",dev=c('pdf')}
par(mfcol=c(2,2),mar=c(2,4,1,1)+0.5)
	plot(x0,rt0/1000 , type="n", xaxp=x0_1,cex.axis=1.1,xaxs= "i",yaxs= "i",main="Reclutamientos",ylim=c(0,35),
	xlim=c(2001,2021),ylab=" Número de individuos x 10^3",las=1,xlab="Año",cex.lab=1.1)
	polygon(x0, rt0/1000 , col=gray(.5,0.5), border="gray80")
	polygon(x0, rt1/1000 , col=gray(.8,0.5), border="gray80")
	lines(years0,Reclutas0/1000,lwd=1,col=1,lty=1)
	lines(years0,Reclutas1/1000,lwd=1,col=2,lty=1)
	abline(h=exp(Ro0+0.5*0.6^2)/1000,col=1,lty=2)
  abline(h=exp(Ro1+0.5*0.6^2)/1000,col=2,lty=2)
  text(2016,c(exp(Ro0+0.5*0.6^2)/1000,exp(Ro1+0.5*0.6^2)/1000)+0.5,c("Rmed_base","Rmed_alternativo"))
box()

plot(x0,bt0/1000,type="n",cex.axis=1.1,xaxs="i",yaxs="i",xlim=c(2001,2021),xaxp=x0_1,ylim=c(0,450),
	main="Biomasa total",ylab="Toneladas x 10^3",las=1,xlab="Año",cex.lab=1.1)  
	polygon(x0,bt0/1000,col=gray(.5,0.5), border="gray80")
	polygon(x0,bt1/1000,col=gray(.8,0.5), border="gray80")
		lines(years0,Bt0/1000,lwd=1,col=1,lty=1)
	lines(years0,Bt1/1000,lwd=1,col=2,lty=1)
box()

plot(x0,ssbt0/1000,type="n",cex.axis=1.1,xaxs="i",yaxs="i",xlim=c(2001,2021),xaxp=x0_1,ylim=c(0,150),
	main="Biomasa desovante",ylab="Toneladas x 10^3",las=1,xlab="Año",cex.lab=1.1)  
	polygon(x0,ssbt0/1000,col=gray(.5,0.5), border="gray80")
	polygon(x0,ssbt1/1000,col=gray(.8,0.5), border="gray80")
	lines(years0,SSBt0/1000,lwd=1,col=1,lty=1)
	lines(years0,SSBt1/1000,lwd=1,col=2,lty=1)
box()

plot(x0, ft0, xaxp=x0_1,cex.axis=1.1,xaxs= "i",yaxs= "i",ylim=c(0,2.5),
	main="Mortalidad por pesca",xlim=c(2001,2021),type="n", ylab="F (año-1)",las=1,xlab="Año",cex.lab=1.1)
	polygon(x0, ft0,  col=gray(.5,0.5), border="gray80")
	polygon(x0, ft1,  col=gray(.8,0.5), border="gray80")
	lines(years0,exp(Ft0),lwd=1,col=1,lty=1)
	lines(years0,exp(Ft1),lwd=1,col=2,lty=1)
box()


```

```{=tex}
\small
\textbf{Figura 34}. Comparación de los reclutamientos, mortalidad por pesca, biomasa total y desovante entre el modelo base y alternativo de sardina austral Región de Los Lagos. Línea negra (modelo base), línea roja (modelo alternativo), región sombreada corresponde al Intervalo de Confianza respectivo de cada modelo (IC).
\normalsize
```
```{r selectividad,warning=F, include=T, message=F, echo=FALSE,fig.height=8,fig.width=10,fig.align="center",fig.path="Figuras/",dev=c('pdf')}

par(mfrow=c(2,2),mar=c(4,4,1,1)+0.5)
plot(rep0$Tallas,rep0$Selflo_talla[1,],type="l",las=1,col=4,ylim=c(0,1.1),ylab="Selectividad Flota",xlab="Tallas (cm)",main="Modelo base")
lines(rep0$Tallas,rep0$Selflo_talla[9,],type="l",col=3)
lines(rep0$Tallas,rep0$Selflo_talla[nyears0,],type="l",col=2)
legend(13,0.3,c("sel_2002-2009","sel_2010-2012","sel_2013-2020"),col=c(4,3,2),lwd=c(1,1,1),cex=0.8,bty="n")

plot(data.1$Edades,rep1$Sflo_age[1,],type="l",las=1,col=4,ylim=c(0,1.1),ylab="Selectividad Flota",xlab="Edades",main="Modelo alternativo")
lines(data.1$Edades,rep1$Sflo_age[9,],type="l",col=3)
lines(data.1$Edades,rep1$Sflo_age[nyears0,],type="l",col=2)
legend(4,0.3,c("sel_2002-2009","sel_2010-2012","sel_2013-2020"),col=c(4,3,2),lwd=c(1,1,1),cex=0.8,bty="n")

plot(rep0$Tallas,rep0$Selcru_talla[1,],type="l",las=1,col=4,ylim=c(0,1.1),ylab="Selectividad Crucero",xlab="Tallas (cm)",main="Modelo base")
lines(rep0$Tallas,rep0$Selcru_talla[nyears0,],type="l",col=2)
legend(13,0.3,c("sel_2002-2012","sel_2013-2020"),col=c(4,2),lwd=c(1,1),cex=0.8,bty="n")

plot(data.1$Edades,rep1$Scru_age[1,],type="l",las=1,col=4,ylim=c(0,1.1),ylab="Selectividad Crucero",xlab="Edades",main="Modelo alternativo")
lines(data.1$Edades,rep1$Scru_age[nyears0,],type="l",col=2)
legend(4,0.3,c("sel_2002-2012","sel_2013-2020"),col=c(4,2),lwd=c(1,1),cex=0.8,bty="n")

```

```{=tex}
\small
\textbf{Figura 35}. Patrón de explotación o selectividad de la flota (panel superior) y de los cruceros acústicos (panel inferior) estimados por el modelo base y alternativo de la sardina austral Región de Los Lagos.
\normalsize
```

### 3.1.6. Comparación del Estado de explotación estimado por el modelo base y alternativo

Los PBRs fueron estimados a partir de un análisis de rendimiento y biomasa por recluta, dado el patrón de selectividad de la flota, pesos medios y madurez sexual a la edad, se estima el nivel de mortalidad por pesca ($F_{RMS}$) asociado a la proporción de la Biomasa Desovante virginal ($BD_0$) considerada objetivo o un proxy basado en la literatura (Clark, 1993; Mace y Sissenwine, 1993). Cabe señalar que la biomasa desovante se calcula al mes de agosto y considera el efecto edad específico de la mortalidad (natural y por pesca). En este análisis se identifica el nivel de referencia biológico 60%BDPR que se supone debería minimizar el impacto de la pesca sobre el stock, permitiendo el escape en torno al 55% de $BD_0$, valor que existiría en ausencia de explotación pesquera (**Tabla 15 y Figura 36**). El valor de $BD_0$ estimado por el modelo alternativo es un 13% mayor al estimado por el modelo base, esto genera que los valores de referencia $BD_{RMS}$ y $BD_{LIM}$ también sean mayores en el modelo alternativo. Estas diferencias impactan leventente en los indicadores del estatus utilizados para definir la condición del recurso, principalmente en términos de $BD/BD_{RMS}$ (**Figura 37**). No obstante, el nivel de $F_{RMS}$ para los últimos años de la serie es similar entre ambos modelos (0.31 modelo base y 0.30 modelo alternativo), no obstante, la mayor variabilidad estimada por el modelo alternativo en la mortalidad por pesca también genera diferencias en la serie de $F/F_{RMS}$, excepto para el último año (**Figura 37**).

\pagebreak

```{r Fspr_baseS1,warning=F, include=T, message=F, echo=FALSE,eval=T}

Tsard<- read.table(paste(getwd(),"/funciones/T0918.txt",sep=""),sep="",na="NA",fill=T) #se debe actualizar esto???
# Probar 3 bloques de selectividad
source(paste(getwd(),"/funciones/Fun_Pbrs.R",sep=""))

nyears1<-length(rep0$Years)

Dat<-list()
Dat$M  	  <- 0.83
Dat$Tspw	<- 0.58
Dat$Mad	  <- data.0$Madurez
Dat$Wmed	<- data.0$Pesos_medios
Dat$Pre   <- rep0$Fun_rec_talla
Ta        <- as.matrix(Tsard)
talla  	  <- data.0$Tallas
edad      <- seq(0,4,1)
Fmort 	  <- seq(0,3,0.01)      
R0 		    <- 1

#Calculo de FRMS para cada bloque de selectividad
Dat$Sel	  <- rep0$Selflo_talla[1,] #bloque 1=[1,], bloque 2=[9,], bloque 3=[19,]
PBRsb1 <- SPRFmort(R0,Fmort,talla,edad,Dat) 
FRMSb1<-subset(PBRsb1,PBRsb1[,4]==0.60)[1]

Dat$Sel	  <- rep0$Selflo_talla[10,] #bloque 1=[1,], bloque 2=[9,], bloque 3=[19,]
PBRsb2 <- SPRFmort(R0,Fmort,talla,edad,Dat) 
FRMSb2<-subset(PBRsb2,PBRsb2[,4]==0.60)[1]

Dat$Sel	  <- rep0$Selflo_talla[nyears1,] #bloque 1=[1,], bloque 2=[9,], bloque 3=[19,]
PBRsb3 <- SPRFmort(R0,Fmort,talla,edad,Dat) 
FRMSb3<-subset(PBRsb3,PBRsb3[,4]==0.60)[1]

FrmsPorBloque<-rbind(Frms_bloque1=FRMSb1,Frms_bloque2=FRMSb2,Frms_bloque3=FRMSb3)
#FrmsPorBloque

# PBRs Modelo base
BDo    <- rep0$BD_virgen_LP 
BRMS   <- BDo*0.55
BDlim  <- BDo*0.275
FRMS   <- data.0$Ind[nyears1,13]

```

```{r Fspr_alternativoS1,warning=F, include=T, message=F, echo=FALSE}

#PBRs Modelo alternativo
BDo1    <- rep1$Bo
BRMS1   <- BDo1*0.55
BDlim1  <- BDo1*0.275
FRMS1   <- exp(subset(std1,name=="log_Fref")$value[3])

```

```{r curvasFrms,warning=F, include=T, message=F,eval=F, echo=FALSE,fig.height=4,fig.width=8,fig.align="center",fig.path="Figuras/",dev=c('pdf')}

par(mfcol=c(1,2),mar=c(4,4,1,1)+0.5)
plot(rep0$Tallas,rep0$Selflo_talla[1,],type="l",las=1,col=4,ylab="Selectividad",xlab="Tallas (cm)")
lines(rep0$Tallas,rep0$Selflo_talla[9,],type="l",col=3)
lines(rep0$Tallas,rep0$Selflo_talla[nyears1,],type="l",col=2)
lines(rep0$Tallas,data.0$Madurez,lwd=2)
legend(13,0.3,c("bloque_sel1","bloque_sel2","bloque_sel3","Madurez"),col=c(4,3,2,1),lwd=c(1,1,1,2),cex=0.8,bty="n")

plot(PBRsb1[,1],PBRsb1[,4],type="l",ylab="%BDPR",xlab="Mortalidad por pesca (F)",lwd=1,las=1,col=4)
lines(PBRsb2[,1],PBRsb2[,4],col=3,lwd=1)
lines(PBRsb3[,1],PBRsb3[,4],col=2,lwd=1)
abline(h=0.6,col=1,lty=1)
abline(v=c(FRMSb1,FRMSb2,FRMSb3),col=c(4,3,2),lty=2)
	text(1.5,c(0.55,0.50,0.45),c("F60_sel1=0,33", "F60_sel2=0,26","F60_sel3=0,31"),cex=0.8,col=c(4,3,2))

```

```{r echo=FALSE,eval=TRUE}

yrs     <- rep0$Years
nyrs    <- length(yrs)
tallas  <- seq(5,19.5,0.5)
ntallas <- length(tallas)
age     <- seq(0,4,1)
nage    <- length(age)

x  <-c(yrs,rev(yrs))
x1 <-c(yrs[1],yrs[nyrs]+1,nyrs+1/2) #xaxp
x2 <-c(yrs[1]-1,yrs[nyrs]+1) #xlim

years1    <-rep1$YRS

#modelo base
Rpr0     <-subset(std0,name=="RPR")$value
Rpr0std  <-subset(std0,name=="RPR")$std
Frpr0    <-subset(std0,name=="Frpr")$value
Frpr0std <-subset(std0,name=="Frpr")$std
rpr0     <-c((Rpr0-1.96*Rpr0std),rev((Rpr0+1.96*Rpr0std))); 
frpr0    <-c((Frpr0-1.96*Frpr0std),rev((Frpr0+1.96*Frpr0std)))
#modelo alternativo
Rpr1     <-subset(std1,name=="RPRrms")$value
Rpr1std  <-subset(std1,name=="RPRrms")$std
Frpr1    <-subset(std1,name=="Frpr")$value
Frpr1std <-subset(std1,name=="Frpr")$std
rpr1     <-c((Rpr1-1.96*Rpr1std),rev((Rpr1+1.96*Rpr1std))); 
frpr1    <-c((Frpr1-1.96*Frpr1std),rev((Frpr1+1.96*Frpr1std)))

### *modelo base*
# biomasa desovante vs BDrms
xbs1 <-rnorm(1000, mean = Rpr0[length(years1)], sd = Rpr0std[length(years1)])
xbs  <-seq(min(xbs1),max(xbs1),0.005)
ybs  <-dnorm(xbs, mean = Rpr0[length(years1)], sd =Rpr0std[length(years1)])
icbs <-qnorm(c(0.05,0.95,0.5),Rpr0[length(years1)],Rpr0std[length(years1)])
xxbs <-c(xbs[xbs>=icbs[1]&xbs<=icbs[2]],rev(xbs[xbs>=icbs[1]&xbs<=icbs[2]]))
yybs <-c(ybs[xbs>=icbs[1]&xbs<=icbs[2]],rep(0,length(ybs[xbs>=icbs[1]&xbs<=icbs[2]])))
# mortalidad por pesca vs Frms
xfs1 <- rnorm(1000, mean = Frpr0[length(years1)], sd = Frpr0std[length(years1)])
xfs  <-seq(min(xfs1),max(xfs1),0.005)
yfs  <-dnorm(xfs, mean = Frpr0[length(years1)], sd =Frpr0std[length(years1)])
icfs <-qnorm(c(0.05,0.95,0.5),Frpr0[length(years1)],Frpr0std[length(years1)])
xxfs <-c(xfs[xfs>=icfs[1]&xfs<=icfs[2]],rev(xfs[xfs>=icfs[1]&xfs<=icfs[2]]))
yyfs <-c(yfs[xfs>=icfs[1]&xfs<=icfs[2]],rep(0,length(yfs[xfs>=icfs[1]&xfs<=icfs[2]])))

### *modelo altarnativo*
# biomasa desovante vs BDrms
xbm1 <-rnorm(1000, mean = Rpr1[length(years1)], sd = Rpr1std[length(years1)])
xbm  <-seq(min(xbm1),max(xbm1),0.005)
ybm  <-dnorm(xbm, mean = Rpr1[length(years1)], sd =Rpr1std[length(years1)])
icbm <-qnorm(c(0.05,0.95,0.5),Rpr1[length(years1)],Rpr1std[length(years1)])
xxbm <-c(xbm[xbm>=icbm[1]&xbm<=icbm[2]],rev(xbm[xbm>=icbm[1]&xbm<=icbm[2]]))
yybm <-c(ybm[xbm>=icbm[1]&xbm<=icbm[2]],rep(0,length(ybm[xbm>=icbm[1]&xbm<=icbm[2]])))
# mortalidad por pesca vs Frms
xfm1 <-rnorm(1000, mean = Frpr1[length(years1)], sd = Frpr1std[length(years1)])
xfm  <-seq(min(xfm1),max(xfm1),0.005)
yfm  <-dnorm(xfm, mean = Frpr1[length(years1)], sd =Frpr1std[length(years1)])
icfm <-qnorm(c(0.05,0.95,0.5),Frpr1[length(years1)],Frpr1std[length(years1)])
xxfm <-c(xfm[xfm>=icfm[1]&xfm<=icfm[2]],rev(xfm[xfm>=icfm[1]&xfm<=icfm[2]]))
yyfm <-c(yfm[xfm>=icfm[1]&xfm<=icfm[2]],rep(0,length(yfm[xfm>=icfm[1]&xfm<=icfm[2]])))

### *Probabilidad de estar bajo BRMS* 
pa1<-pnorm(1,Rpr0[length(years1)],Rpr0std[length(years1)],lower.tail = TRUE,log.p = F)
pa2<-pnorm(1,Rpr1[length(years1)],Rpr1std[length(years1)],lower.tail = TRUE,log.p = F)
### *Probabilidad de estar bajo FRMS*
pb1<-1-pnorm(1,Frpr0[length(years1)],Frpr0std[length(years1)],lower.tail = TRUE,log.p = F)
pb2<-1-pnorm(1,Frpr1[length(years1)],Frpr1std[length(years1)],lower.tail = TRUE,log.p = F)
### *Probabilidad de estar en zona de sobreexplotacion*
pc1<-pnorm(0.9,Rpr0[length(years1)],Rpr0std[length(years1)],lower.tail = TRUE,log.p = F)
pc2<-pnorm(0.9,Rpr1[length(years1)],Rpr1std[length(years1)],lower.tail = TRUE,log.p = F)
### *Probabilidad de estar en zona de colapso*
pd1<-pnorm(0.5,Rpr0[length(years1)],Rpr0std[length(years1)],lower.tail = TRUE,log.p = F)
pd2<-pnorm(0.5,Rpr1[length(years1)],Rpr1std[length(years1)],lower.tail = TRUE,log.p = F)
### *Probailidad de sobrepesca*
pe1<-1-pnorm(1.1,Frpr0[length(years1)],Frpr0std[length(years1)],lower.tail = TRUE,log.p = F)
pe2<-1-pnorm(1.1,Frpr1[length(years1)],Frpr1std[length(years1)],lower.tail = TRUE,log.p = F)

```

```{=tex}
\small
\begin{center} 
 \textbf{Tabla 15.}
 \end{center}
 \begin{center} 
 \vspace{-0.2cm} Puntos Biológicos de Referencia (PBRs) y probabilidades de estar bajo $BD_{RMS}$ y sobre $F_{RMS}$ y en sobreexplotación, colapsado o sobrepesca, calculados por el modelo base y alternativo.
 \end{center}
 \normalsize
 \vspace{-0.2cm}
```
```{r echo=FALSE,eval=T}

PBRs<-round(rbind("BD~0~"=c(BDo,BDo1)/1000,
                  "BD~RMS~"=c(BRMS,BRMS1)/1000,
                  "BD~LIM~"=c(BDlim,BDlim1)/1000,
                  "F~RMS~"=c(FRMS,FRMS1),
                  "p(BD~2020~<BD~RMS)~"=round(c(pa1,pa2),2),
                  "p(F~2020~>F~RMS~)"=round(c(pb1,pb2),2),
                  "*p(sobreexplotación)*"=round(c(pc1,pc2),2),
                  "*p(agotado/colapsado)*"=round(c(pd1,pd2),2),
                  "*p(sobrepesca)*"=round(c(pe1,pe2),2)),3)

colnames(PBRs)<-c("base","alternativo")
kable(PBRs)

```

```{r BD0_BDRMS_BDLIM,warning=F, include=T, message=F, echo=FALSE,fig.height=8,fig.width=10,fig.align="center",fig.path="Figuras/",dev=c('pdf')}

  par(mfcol=c(2,2),mar=c(2,4,1,1)+0.5)
  plot(x0,ssbt0/1000,type="n",cex.axis=1.1,xaxs="i",yaxs="i",xlim=c(2001,2021),xaxp=x0_1,ylim=c(0,150),
	main="Modelo base",ylab="Biomasa desovante x 10^3",las=1,xlab="Año",cex.lab=1.1)  
  polygon(x0,ssbt0/1000,col=gray(.6,0.5), border="gray80")
	lines(years0,SSBt0/1000,lwd=1,col=1,lty=1)
	abline(h=c(BDo,BRMS,BDlim)/1000,col=c(1,3,2))
  text(rep(2017,3),(c(BDo,BRMS,BDlim)/1000)+5,round(c(BDo,BRMS,BDlim)/1000,1))
  text(rep(2014.5,3),(c(BDo,BRMS,BDlim)/1000)+5,c("BDo =","BDrms =","BDlim ="))
  
  plot(x0, ft0, xaxp=x0_1,cex.axis=1.1,xaxs= "i",yaxs= "i",ylim=c(0,2.5),
	main="Modelo base",xlim=c(2000,2021),type="n", ylab="Mortalidad por pesca",las=1,xlab="Año",cex.lab=1.1)
	polygon(x0, ft0,  col=gray(.6,0.5), border="gray80")
	lines(years0,exp(Ft0),lwd=1,col=1,lty=1)
	lines(years0,data.0$Ind[,13], col=3)
	text(c(2004,2011,2018),c(FRMSb1,FRMSb2,FRMSb3)-0.08,paste("Frms =", c(FRMSb1,FRMSb2,FRMSb3),sep=""))

	plot(x0,ssbt1/1000,type="n",cex.axis=1.1,xaxs="i",yaxs="i",xlim=c(2001,2021),xaxp=x0_1,ylim=c(0,150),
	main="Modelo alternativo",ylab="Biomasa desovante x 10^3",las=1,xlab="Año",cex.lab=1.1)  
	polygon(x0,ssbt1/1000,col=gray(.6,0.5), border="gray80")
	lines(years0,SSBt1/1000,lwd=1,col=1,lty=1)
	abline(h=c(BDo1,BRMS1,BDlim1)/1000,col=c(1,3,2))
	text(rep(2017,3),(c(BDo1,BRMS1,BDlim1)/1000)+5,round(c(BDo1,BRMS1,BDlim1)/1000,1))
  text(rep(2014.5,3),(c(BDo1,BRMS1,BDlim1)/1000)+5,c("BDo =","BDrms =","BDlim ="))
 
	plot(x0, ft1, xaxp=x0_1,cex.axis=1.1,xaxs= "i",yaxs= "i",ylim=c(0,2.5),
	main="Modelo alternativo",xlim=c(2000,2021),type="n", ylab="Mortalidad por pesca",las=1,xlab="Año",cex.lab=1.1)
	polygon(x0, ft1,  col=gray(.6,0.5), border="gray80")
	lines(years0,exp(Ft1),lwd=1,col=1,lty=1)
  lines(years0,data.1$Ind[,13], col=3)
  text(c(2004,2011,2018),c(data.1$Ind[1,13],data.1$Ind[9,13],data.1$Ind[19,13])-0.08,paste("Frms =", c(data.1$Ind[1,13],data.1$Ind[9,13],data.1$Ind[19,13]),sep=""))

```

```{=tex}
\small
\textbf{Figura 36}. Serie de biomasa desovante y mortalidad por pesca junto a los PBRs correspondientes. las línas horizontales corresponden a los siguientes PBRs: línea negra es $BD_0$, línea verde es $BD_{RMS}$ y $F_{RMS}$ y línea roja es $BD_{LIM}$ calculados por el modelo base (panel izquierdo) y modelo alternativo (panel derecho).
\normalsize
```
\pagebreak

```{r estatus,warning=F, include=T, message=F, echo=FALSE,fig.height=7,fig.width=9,fig.align="center",fig.path="Figuras/",dev=c('pdf')}

par(mfcol=c(2,2),mar=c(2,4,1,1)+0.5)
	plot(x0, rpr1,type="n",ylim=c(0,4),cex.axis=0.8,xaxs="i",yaxs="i",xlim=c(2001,2021),xaxp=x0_1,
	ylab=expression("BD/BD"[RMS]),las=1,xlab="Año",cex.lab=1.1)
polygon(x0,rpr0, col=gray(.5,0.5),border="gray80")
polygon(x0,rpr1, col=gray(.8,0.5),border="gray80")
lines(years1,Rpr0,lwd=1,col=1,lty=1)#base
lines(years1,Rpr1,lwd=1,col="red2",lty=1) #alternativo
abline(h=c(0.5,1),lty=2,col=c("red","green3"))
text(c(2006,2006),c(0.5,1)+0.05,c(expression("BD"[LIM]),expression("BD"[RMS])),cex=1.2)
legend(2008,4,c("modelo base","modelo alternativo"),lty=c(1,1),col=c("black","red2"),bty="n",lwd=1)
box()

plot(x0,frpr1,type="n",ylim=c(0,5),cex.axis=0.8,xaxs="i",yaxs="i",xlim=c(2001,2021),xaxp=x0_1,                ylab=expression("F/F"[RMS]),las=1,xlab="Año",cex.lab=1.1)                
polygon(x0,frpr0,col=gray(.5,0.5), border="gray80")
polygon(x0,frpr1,col=gray(.8,0.5), border="gray80")
lines(years1,Frpr0,lwd=1,col=1,lty=1)   #base
lines(years1,Frpr1,lwd=1,col="red2",lty=1) #alternativo
abline(h=1,lty=2,col="green3")
text(2009,1+0.2,expression("F"[RMS]),cex=1.2)
box()

plot(xbs,ybs,type="l",ylab="Densidad de probabilidad",xaxs="i",
	xlab=expression("BD"[last]*"/BD"[RMS]),las=1,yaxs= "i",ylim=c(0,2.8),xlim=c(0.2,2.2))
polygon(xxbs,yybs,col=gray(0.5,0.5),border="gray80")
polygon(xxbm,yybm,col=gray(0.8,0.7),border="gray80")
lines(xbs,ybs,lwd=1,lty=1)
lines(xbm,ybm,lwd=1,col="red2",lty=1)
legend(0.4,2.8,c(paste("base_IC95% = [",round(icbs[1],3),"-",round(icbs[2],3),"]",sep=" "),paste("alternativo_IC95% = [",round(icbm[1],3),"-",round(icbm[2],3),"]",sep=" ")), lty=c(1,1),col=c("black","red2"),bty="n",lwd=1)
box()

plot(xfs,yfs,type="n",ylab="Densidad de probabilidad",xaxs="i",
	xlab=expression("F"[last]*"/F"[RMS]),las=1,yaxs= "i",ylim=c(0,2.8),xlim=c(0,1.5))
polygon(xxfs,yyfs,col=gray(0.5,0.5),border="gray80")
polygon(xxfm,yyfm,col=gray(0.8,0.5),border="gray80")
lines(xfs,yfs,lwd=1,lty=1)
lines(xfm,yfm,lwd=1,col="red2",lty=1)
legend(0.1,2.8,c(paste("base_IC95% = [",round(icfs[1],3),"-",round(icfs[2],3),"]",sep=" "),paste("alternativo_IC95% = [",round(icfm[1],3),"-",round(icfm[2],3),"]",sep=" ")), lty=c(1,1),col=c("black","red2"),bty="n",lwd=1)
box()

```

```{=tex}
\small
\textbf{Figura 37}. Comparación de la razón $BD/BD_{RMS}$, distribución de probabilidad de $BD_{2020}/BD_{RMS}$. Razón $F/F_{RMS}$ y la distribución de probabilidad $F_{2020}/F_{RMS}$. Modelo base (línea negra) y alternativo (línea roja).
\normalsize
```
\pagebreak

### 3.1.7. Comparación con asesorías previas

Se comparan los resultados de los principales indicadores de estado para el modelo base y alternativo para asesorías previas (septiembre 2020, junio 2020, septiembre 2019, abril 2019) para evaluar la consistencia de cada modelo. El desempeño histórico se ilustra en la **Figura 38**, en las cuales se observa un adecuado nivel de convergencia histórica. Las diferencias ocurren en los tre últimos años (2018, 2019 y 2020), observándose una tendencia a subestimar los niveles de reclutamientos, biomasa desovante y mortalidad por pesca. Esta última debido a la utilización del supuesto de captura en cada hito de manejo. Esto se observa con mayor detalle en la determinación del estatus 2020 de la asesoría de junio y septiembre 2020 para el modelo base (**Figura 39**) y para el modelo alternativo (**Figura 40**).

```{r asesorias_previas,warning=F, include=T, message=F, echo=FALSE,fig.height=8,fig.width=10,fig.align="center",fig.path="Figuras/",dev=c('pdf')}

   
years.1   <- data1$Ind[,1]  ; nyears.1  <- data1$nanos 
years.0   <- data0$Ind[,1]  ; nyears.0  <- data0$nanos 
R_jun19  <-c(6215,9079,13095,19689,8096,8467,10623,6528,5133,5375,13802,2383,12211,3249,2441,4388,2445,6665,NA)
R_sept19 <-c(6174,9049,13026,19810,8084,8452,10630,6544,5134,5369,13770,2410,12176,3261,2505,4861,2735,4690,NA)

BD_jun19  <-c(40355,56370,55954,56952,74917,58016,37351,29081,28055,26737,29062,44469,37477,40608,30858,17861,17043,17109,NA)
BD_sept19 <-c(39991,56080,55914,57142,75339,58468,37718,29360,28317,26985,29433,44484,37546,40817,31226,18630,19126,18793,NA)

F_jun19  <-c(0.5,0.35,0.4,0.5,0.33,0.6,0.72,0.95,0.38,0.33,0.28,0.29,0.35,0.35,0.43,0.49,0.29,0.33,NA)
F_sept19 <-c(0.5,0.35,0.4,0.49,0.33,0.59,0.71,0.94,0.38,0.33,0.28,0.3,0.37,0.36,0.43,0.48,0.26,0.34,NA)

#modelo base
dat3c <- data.frame(years=years.0,Rt=c(R_jun19),SSBt=c(BD_jun19),Ft=c(F_jun19))%>%
         mutate(Series=rep("jun19",nyears.0))%>%mutate(Modelo=rep("M_base",nyears.0))%>% melt(id.var=c('years', 'Series','Modelo'))

dat2c <- data.frame(years=years.0,Rt=c(R_sept19),SSBt=c(BD_sept19),Ft=c(F_sept19))%>%
         mutate(Series=rep("sept19",nyears.0))%>%mutate(Modelo=rep("M_base",nyears.0))%>% melt(id.var=c('years', 'Series','Modelo'))

dat1c <- data.frame(years=years.0,Rt=rep.0$Reclutamiento,SSBt=rep.0$Biomasa_desovante,Ft=rep.0$F)%>% 
         mutate(Series=rep("jun20",nyears.0))%>%mutate(Modelo=rep("M_base",nyears.0))%>% melt(id.var=c('years', 'Series','Modelo'))

dat0c <- data.frame(years=years.0,Rt=rep0$Reclutamiento,SSBt=rep0$Biomasa_desovante,Ft=rep0$F)%>% 
         mutate(Series=rep("sept20",nyears.0))%>%mutate(Modelo=rep("M_base",nyears.0))%>% melt(id.var=c('years', 'Series','Modelo'))

#modelo alternativo

dat3b <- data.frame(years=years.1,Rt=c(rep.3$Reclutas,NA),SSBt=c(rep.3$BD,NA),Ft=c(rep.3$F,NA))%>%
         mutate(Series=rep("jun19",nyears.1))%>%mutate(Modelo=rep("M_alternativo",nyears.1))%>% melt(id.var=c('years', 'Series','Modelo'))

dat2b <- data.frame(years=years.1,Rt=c(rep.2$Reclutas,NA),SSBt=c(rep.2$BD,NA),Ft=c(rep.2$F,NA))%>%
         mutate(Series=rep("sept19",nyears.1))%>%mutate(Modelo=rep("M_alternativo",nyears.1))%>% melt(id.var=c('years', 'Series','Modelo'))

dat1b <- data.frame(years=years.1,Rt=rep.1$Reclutas,SSBt=rep.1$BD,Ft=rep.1$F)%>% 
         mutate(Series=rep("jun20",nyears.1))%>%mutate(Modelo=rep("M_alternativo",nyears.1))%>% melt(id.var=c('years', 'Series','Modelo'))

dat0b <- data.frame(years=years.1,Rt=rep1$Reclutas,SSBt=rep1$BD,Ft=rep1$F)%>% 
         mutate(Series=rep("sept20",nyears.1))%>%mutate(Modelo=rep("M_alternativo",nyears.1))%>% melt(id.var=c('years', 'Series','Modelo'))

data <- data.frame(rbind(dat3b,dat2b,dat1b,dat0b,dat3c,dat2c,dat1c,dat0c))  

# Modelo base
f1<- ggplot(data %>% filter(variable=='Rt',Modelo=='M_base'),aes(years,value/10^6)) + 
     geom_line(aes(colour=Series), size=0.3)+
     labs(x = '', y = 'Reclutamientos',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1990, to = 2020, by = 5)) +
     scale_colour_manual(values=seq(1,5,1))+
     theme_bw(base_size=11) + 
     ggtitle('Modelo base')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

f2<- ggplot(data %>% filter(variable=='SSBt',Modelo=='M_base'),aes(years,value/10^6)) + 
     geom_line(aes(colour=Series), size=0.3)+
     labs(x = '', y = 'Biomasa desovante (t)',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1990, to = 2020, by = 5)) +
     scale_colour_manual(values=seq(1,5,1))+
     theme_bw(base_size=11) + 
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

f3<- ggplot(data %>% filter(variable=='Ft',Modelo=='M_base'),aes(years,value)) + 
     geom_line(aes(colour=Series), size=0.3)+
     labs(x = '', y = 'Mortalidad por pesca',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1990, to = 2020, by = 5)) +
     scale_colour_manual(values=seq(1,5,1))+
     theme_bw(base_size=11) + 
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

# Modelo alternativo
f4<- ggplot(data %>% filter(variable=='Rt',Modelo=='M_alternativo'),aes(years,value/10^6)) + 
     geom_line(aes(colour=Series), size=0.3)+
     labs(x = '', y = '',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1990, to = 2020, by = 5)) +
     scale_colour_manual(values=seq(1,5,1))+
     theme_bw(base_size=11) + 
     ggtitle('Modelo alternativo')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

f5<- ggplot(data %>% filter(variable=='SSBt',Modelo=='M_alternativo'),aes(years,value/10^6)) + 
     geom_line(aes(colour=Series), size=0.3)+
     labs(x = '', y = '',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1990, to = 2020, by = 5)) +
     scale_colour_manual(values=seq(1,5,1))+
     theme_bw(base_size=11) + 
     theme(plot.title = element_text(hjust = 0.5))

f6<- ggplot(data %>% filter(variable=='Ft',Modelo=='M_alternativo'),aes(years,value)) + 
     geom_line(aes(colour=Series), size=0.3)+
     labs(x = '', y = '',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1990, to = 2020, by = 5)) +
     scale_colour_manual(values=seq(1,5,1))+
     theme_bw(base_size=11) + 
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")


 (f1/f2/f3)  | (f4/f5/f6) 

```

```{=tex}
\small 
\textbf{Figura 38}. Comparación de los reclutamientos, biomasa desovante y mortalidad por pesca estimadas en asesorías anteriores por el modelo base (panel izquierdo) y modelo alternativo (panel derecho). 
\normalsize
```
\pagebreak

```{r DiagramaFase_modelobaseJUNIO, warning=F, include=T, message=F, echo=FALSE,fig.height=4,fig.width=4,fig.align="center",out.extra = 'angle=0',fig.path="Figuras/",dev=c('pdf')}

source(paste(getwd(),"/funciones/Fn_DiagramaFase.R",sep="")) 
name1<-"Modelo base Asesoría Junio 2020"
years1<-rep.0$Years
  
SSBt1         <- subset(std.0,name=="BD")$value
SSBt1std      <- subset(std.0,name=="BD")$std
Ft1           <- subset(std.0,name=="log_F")$value
Ft1std        <- subset(std.0,name=="log_F")$std
BDo     <- rep.0$BD_virgen_LP 
BRMS1   <- BDo*0.55
FRMS1   <- data0$Ind[nyears1,13]

DiagramaFase(name1,FRMS1,BRMS1,SSBt1,SSBt1std,Ft1,Ft1std,years1)
#cruz del año previo
lastB1    <- SSBt1[nyears1-1]/BRMS1
lastB    <- SSBt1[nyears1-1]
lastF    <- exp(Ft1[nyears1-1])/FRMS1
# Calculate confidence intervals
Qmult    <- -qnorm((1-(80/100))/2.0)
sbSE     <- SSBt1std[nyears1-1]
sb95     <- c(lastB-Qmult*sbSE,lastB+Qmult*sbSE)
B95      <- sb95/BRMS1
FvSE     <- Ft1std[nyears1-1]
F95      <- c(lastF*exp(-Qmult*FvSE),lastF*exp(Qmult*FvSE))
arrows(x0=B95[1],y0=lastF,x1=B95[2],y1=lastF,length=0.05,angle=90,col=4,lwd=1,code=3)
arrows(x0=lastB1,y0=F95[1],x1=lastB1,y1=F95[2],length=0.05,angle=90,col=4,lwd=1,code=3)
points(lastB1,lastF,pch=19,col=4)
text(lastB1,lastF-0.1,years0[nyears0-1],cex=0.8) 

```

```{r DiagramaFase_modelobase, warning=F, include=T, message=F, echo=FALSE,fig.height=4,fig.width=4,fig.align="center",fig.path="Figuras/",dev=c('pdf')}

source(paste(getwd(),"/funciones/Fn_DiagramaFase.R",sep="")) 
name<-"Modelo base Asesoría Septiembre 2020"
DiagramaFase(name,FRMS,BRMS,SSBt0,SSBt0std,Ft0,Ft0std,years0)
#cruz del año previo
lastB1    <- SSBt0[nyears0-1]/BRMS
lastB    <- SSBt0[nyears0-1]
lastF    <- exp(Ft0[nyears0-1])/FRMS
# Calculate confidence intervals
Qmult    <- -qnorm((1-(80/100))/2.0)
sbSE     <- SSBt0std[nyears0-1]
sb95     <- c(lastB-Qmult*sbSE,lastB+Qmult*sbSE)
B95      <- sb95/BRMS
FvSE     <- Ft0std[nyears0-1]
F95      <- c(lastF*exp(-Qmult*FvSE),lastF*exp(Qmult*FvSE))
arrows(x0=B95[1],y0=lastF,x1=B95[2],y1=lastF,length=0.05,angle=90,col=4,lwd=1,code=3)
arrows(x0=lastB1,y0=F95[1],x1=lastB1,y1=F95[2],length=0.05,angle=90,col=4,lwd=1,code=3)
points(lastB1,lastF,pch=19,col=4)
text(lastB1,lastF-0.1,years0[nyears0-1],cex=0.8) 
```

```{=tex}
\footnotesize
\textbf{Figura 39}. Diagrama de fases de explotación de la biomasa desovante respecto de la mortalidad por pesca de la evaluación del modelo base para la asesoría de junio 2020 (panel superior) y septiembre 2020 (panel inferior). Cruz azul correponde a los intervalos de confianza de la razón $BD/BD_{RMS}$ y $F/F_{RMS}$. El año con cruz continua corresponde a "$Estatus_{completo}$" y la cruz con línea discontinua a "$Estatus_{preliminar}$".
\normalsize
```
```{r DiagramaFase_modeloalternativoJUNIO, warning=F, include=T, message=F, echo=FALSE,fig.height=4,fig.width=4,fig.align="center", out.extra = 'angle=0',fig.path="Figuras/",dev=c('pdf')}

source(paste(getwd(),"/funciones/Fn_DiagramaFase.R",sep="")) 
name1<-"Modelo alternativo Asesoría Junio 2020"
years1<-rep.1$YRS
SSBt1         <- subset(std.1,name=="BD")$value
SSBt1std      <- subset(std.1,name=="BD")$std
Ft1           <- subset(std.1,name=="log_F")$value
Ft1std        <- subset(std.1,name=="log_F")$std
BDo1    <- rep.1$Bo
BRMS1   <- BDo1*0.55
FRMS1   <- exp(subset(std.1,name=="log_Fref")$value[1])

DiagramaFase(name1,FRMS1,BRMS1,SSBt1,SSBt1std,Ft1,Ft1std,years1)
#cruz del año previo
lastB1    <- SSBt1[nyears1-1]/BRMS1
lastB    <- SSBt1[nyears1-1]
lastF    <- exp(Ft1[nyears1-1])/FRMS1
# Calculate confidence intervals
Qmult    <- -qnorm((1-(80/100))/2.0)
sbSE     <- SSBt1std[nyears1-1]
sb95     <- c(lastB-Qmult*sbSE,lastB+Qmult*sbSE)
B95      <- sb95/BRMS1
FvSE     <- Ft1std[nyears1-1]
F95      <- c(lastF*exp(-Qmult*FvSE),lastF*exp(Qmult*FvSE))
arrows(x0=B95[1],y0=lastF,x1=B95[2],y1=lastF,length=0.05,angle=90,col=4,lwd=1,code=3)
arrows(x0=lastB1,y0=F95[1],x1=lastB1,y1=F95[2],length=0.05,angle=90,col=4,lwd=1,code=3)
points(lastB1,lastF,pch=19,col=4)
text(lastB1,lastF-0.1,years0[nyears0-1],cex=0.8) 

```

```{r DiagramaFase_modeloalternativo, warning=F, include=T, message=F, echo=FALSE,fig.height=4,fig.width=4,fig.align="center",fig.path="Figuras/",dev=c('pdf')}
BDo1    <- rep1$Bo
BRMS1   <- BDo1*0.55
BDlim1  <- BDo1*0.275
FRMS1   <- exp(subset(std1,name=="log_Fref")$value[3])
SSBt1         <- subset(std1,name=="BD")$value
SSBt1std      <- subset(std1,name=="BD")$std
Ft1           <- subset(std1,name=="log_F")$value
Ft1std        <- subset(std1,name=="log_F")$std

source(paste(getwd(),"/funciones/Fn_DiagramaFase.R",sep="")) 
name1<-"Modelo alternativo Asesoría Septiembre 2020"
DiagramaFase(name1,FRMS1,BRMS1,SSBt1,SSBt1std,Ft1,Ft1std,years1)
#cruz del año previo
lastB1    <- SSBt1[nyears1-1]/BRMS1
lastB    <- SSBt1[nyears1-1]
lastF    <- exp(Ft1[nyears1-1])/FRMS1
# Calculate confidence intervals
Qmult    <- -qnorm((1-(80/100))/2.0)
sbSE     <- SSBt1std[nyears1-1]
sb95     <- c(lastB-Qmult*sbSE,lastB+Qmult*sbSE)
B95      <- sb95/BRMS1
FvSE     <- Ft1std[nyears1-1]
F95      <- c(lastF*exp(-Qmult*FvSE),lastF*exp(Qmult*FvSE))
arrows(x0=B95[1],y0=lastF,x1=B95[2],y1=lastF,length=0.05,angle=90,col=4,lwd=1,code=3)
arrows(x0=lastB1,y0=F95[1],x1=lastB1,y1=F95[2],length=0.05,angle=90,col=4,lwd=1,code=3)
points(lastB1,lastF,pch=19,col=4)
text(lastB1,lastF-0.1,years0[nyears0-1],cex=0.8) 
```

```{=tex}
\footnotesize
\textbf{Figura 40}. Diagrama de fases de explotación de la biomasa desovante respecto de la mortalidad por pesca de la evaluación del modelo alternativo para la asesoría de junio 2020 (panel superior) y septiembre 2020 (panel inferior). Cruz azul correponde a los intervalos de confianza de la razón $BD/BD_{RMS}$ y $F/F_{RMS}$. El año con cruz continua corresponde a "$Estatus_{completo}$" y la cruz con línea discontinua a "$Estatus_{preliminar}$".
\normalsize
```
\pagebreak

### 3.1.8. Comparación de la proyección de la Captura Biológicamente Aceptable (CBA inicial - Hito 1)

\vspace{0.5cm}

La CBA inicial es estimada bajo tres escenarios de posibles estados de la naturaleza (reclutamiento alto, medio y bajo) y para distinto percentiles de probabilidad en el primer hito de determinación de CBA (septiembre de cada año). La **Figura 41** muestra los escenarios de reclutamiento utilizados para el cálculo de CBA 2020 y 2021 estimada por el modelo base y alternativo. La **Tabla 16** muestran los valores de CBA proyectada para el año 2020 y 2021 por el modelo base y alternativo bajo los tres escenarios de reclutamiento y percentiles de probabilidad de captura entre el 10% y 50%. Al respecto, en ambos modelos el escenario de reclutamientos altos es el que genera los mayores niveles de captura, siendo el modelo base quien estima los mayores niveles. Al respecto. Las **Figuras 42 y 44** muestra el efecto del escenario de reclutamiento sobre la estructura de tallas vulnerada, reflejando que los escenarios de reclutamiento impactan a un mayor rango de tallas en el modelo base, generando mayores niveles de captura en el escenario de reclutamiento alto. Este efecto tiene relación con el patrón de selectividad de la flota y en segundo lugar por la amplitud del patrón de reclutamiento estimada por el modelo base. Las **Figuras 43 y 45** indican que la CBA proyectada por el modelo base es un 12% mayor al estimado por el modelo alternativo, considerando el escenario de reclutamiento medio como referencia.

### 3.1.9. Comparación de CBA calculado para el mismo año (Revisión de CBA - Hito 2)

El valor de CBA resultante desde el modelo base y alternativo se muestra en la **Tabla 17**. Se aprecian mínimas diferencias entre ambas aproximaciones, siendo tales diferencias estadísticamente no significativas. La densidad de probabilidad de la CBA 2020 para el percentil del 50% muestra coincidencia entre ambos enfoques de modelación (**Figura 46**). La diferencia gráfica para cada percentil de probabilidad es también mínima.

\pagebreak

```{r Rproy_sept2019,warning=F, include=T, message=F, echo=FALSE,fig.height=4,fig.width=7,fig.align="center",fig.path="Figuras/",dev=c('pdf')}

dirb<-paste(dir.0,"/cba_septiembre2019_base",sep="")
setwd(dirb)
reps1b     <- reptoRlist("MTT0819s1.rep")  
reps2b     <- reptoRlist("MTT0819s2.rep") 
reps3b     <- reptoRlist("MTT0819s3.rep") 

dira<-paste(dir.0,"/cba_septiembre2019_alternativo",sep="")
setwd(dira)
reps1a     <- reptoRlist("MAT0919s1.rep")  
reps2a     <- reptoRlist("MAT0919s2.rep") 
reps3a     <- reptoRlist("MAT0919s3.rep") 


par(mfcol=c(2,2),mar=c(2,4,1,1)+0.5)

# modelo base
plot(reps1b$Years,reps1b$Reclutamiento,type="l",ylab="Reclutamientos",xlab="Años",main="Escenarios de reclutamiento - CBA 2020 - M. base",cex.axis=0.7,cex.main=0.7,cex.lab=0.7)
abline(h=c(exp(8.6053e+000),reps2b$Reclutamiento[11],reps3b$Reclutamiento[17]),col=c(1,2,3))
text(2010,c(exp(8.6053e+000),reps2b$Reclutamiento[11],reps3b$Reclutamiento[17])+1000,round(c(exp(8.6053e+000),reps2b$Reclutamiento[11],reps3b$Reclutamiento[17]),0),cex=0.7)

# modelo alternativo
plot(reps1a$YRS,reps1a$Reclutas,type="l",ylab="Reclutamientos",xlab="Años",main="Escenarios de reclutamiento - CBA 2020 - M. alternativo",cex.axis=0.7,cex.main=0.7,cex.lab=0.7)
abline(h=c(reps1a$Rproy,reps2a$Rproy,reps3a$Rproy),col=c(1,2,3))
text(2010,c(reps1a$Rproy,reps2a$Rproy,reps3a$Rproy)+1000,round(c(reps1a$Rproy,reps2a$Rproy,reps3a$Rproy),0),cex=0.7)

##########################################################
dirb<-paste(dir.0,"/cba_septiembre2020_base",sep="")
setwd(dirb)
reps1b     <- reptoRlist("MTT0920s1.rep")  
reps2b     <- reptoRlist("MTT0920s2.rep") 
reps3b     <- reptoRlist("MTT0920s3.rep") 

dira<-paste(dir.0,"/cba_septiembre2020_alternativo",sep="")
setwd(dira)
reps1a     <- reptoRlist("MAT0920s1.rep")  
reps2a     <- reptoRlist("MAT0920s2.rep") 
reps3a     <- reptoRlist("MAT0920s3.rep") 


#par(mfcol=c(2,2),mar=c(4,4,1,1)+0.5)

# modelo base
plot(reps1b$Years,reps1b$Reclutamiento,type="l",ylab="Reclutamientos",xlab="Años",main="Escenarios de reclutamiento - CBA 2021 - M. base",cex.axis=0.7,cex.main=0.7,cex.lab=0.7)
abline(h=c(exp(8.6053e+000),reps2b$Reclutamiento[11],reps3b$Reclutamiento[17]),col=c(1,2,3))
text(2010,c(exp(8.6053e+000),reps2b$Reclutamiento[11],reps3b$Reclutamiento[17])+1000,round(c(exp(8.6053e+000),reps2b$Reclutamiento[11],reps3b$Reclutamiento[17]),0),cex=0.7)

# modelo alternativo
plot(reps1a$YRS,reps1a$Reclutas,type="l",ylab="Reclutamientos",xlab="Años",main="Escenarios de reclutamiento - CBA 2021- M. alternativo",cex.axis=0.7,cex.main=0.7,cex.lab=0.7)
abline(h=c(reps1a$Rproy,reps2a$Rproy,reps3a$Rproy),col=c(1,2,3))
text(2010,c(reps1a$Rproy,reps2a$Rproy,reps3a$Rproy)+1000,round(c(reps1a$Rproy,reps2a$Rproy,reps3a$Rproy),0),cex=0.7)



```

```{=tex}
\vspace{-0.4cm}
\footnotesize 
\textbf{Figura 41}. Comparación de los escenarios de reclutamientos utilizados para la proyección de CBA 2020 y 2021  calculada por el modelo base (panel superior) y alternativo (panel inferior). Línea roja es Ralto, línea negra es Rmed y línea verde es Rbajo.
\normalsize
```
\vspace{0.5cm}

```{r cba2020_modelobase_sept2019,warning=F, include=T, message=F, echo=FALSE,eval=T }

dir<-paste(dir.0,"/cba_septiembre2019_base",sep="")
admb<-"/MTT0819"

stds1b     <- read.table(paste(dir,admb,"s1.std", sep=''),header=T,sep="",na="NA",fill=T)
stds2b     <- read.table(paste(dir,admb,"s2.std", sep=''),header=T,sep="",na="NA",fill=T)
stds3b     <- read.table(paste(dir,admb,"s3.std", sep=''),header=T,sep="",na="NA",fill=T) 
# es tres porque proyecté solo un año
# es 11 cuando proyecto 5 años
cbas1b     <- subset(stds1b ,name=="Yp")$value[4] 
cbas1bstd  <- subset(stds1b ,name=="Yp")$std[4] #reclutamiento medios
cbas2b     <- subset(stds2b ,name=="Yp")$value[4] 
cbas2bstd  <- subset(stds2b ,name=="Yp")$std[4] #reclutamiento medios
cbas3b     <- subset(stds3b ,name=="Yp")$value[4] 
cbas3bstd  <- subset(stds3b ,name=="Yp")$std[4] #reclutamiento medios

q       <- seq(0.1,0.5,0.1)  # niveles de riesgo (cuantiles)                             
nq      <- length(q)                                                                                   
CBAs1b     <- rep(0,nq)
CBAs2b     <- rep(0,nq)
CBAs3b   <- rep(0,nq)
buffer1b   <- rep(0,nq)
buffer2b   <- rep(0,nq)
buffer3b   <- rep(0,nq)

for(j in 1:nq){
  CBAs1b[j]<-qnorm(q[j],cbas1b,cbas1bstd )
  CBAs2b[j]<-qnorm(q[j],cbas2b,cbas2bstd )
  CBAs3b[j]<-qnorm(q[j],cbas3b,cbas3bstd )
  }
for(j in 1:nq){
    buffer1b[j] <-round(1-CBAs1b[j]/CBAs1b[5],2)
    buffer2b[j] <-round(1-CBAs2b[j]/CBAs2b[5],2)
    buffer3b[j] <-round(1-CBAs3b[j]/CBAs3b[5],2)
  }

tCBA1<-cbind(percentil=c(seq(10,50,10)),CBA_Rmed=round(CBAs1b,0),CBA_Ralto=round(CBAs2b,0),CBA_Rbajo=round(CBAs3b,0))
#kable((tCBA1))
tCBA2<-cbind(percentil=c(seq(10,50,10)),CBA_Ralto=round(CBAs2b,0),Resguardo=buffer2b)
#kable((tCBA2))
tCBA3<-cbind(percentil=c(seq(10,50,10)),CBA_Rbajo=round(CBAs3b,0),Resguardo=buffer3b)
#kable((tCBA3))
```

```{r cba2020_modeloalternativo_sept2019,warning=F, include=T, message=F, echo=FALSE,eval=T }

dir<-paste(dir.0,"/cba_septiembre2019_alternativo",sep="")
admb<-"/MAT0919"

stds1a     <- read.table(paste(dir,admb,"s1.std", sep=''),header=T,sep="",na="NA",fill=T)
stds2a     <- read.table(paste(dir,admb,"s2.std", sep=''),header=T,sep="",na="NA",fill=T)
stds3a     <- read.table(paste(dir,admb,"s3.std", sep=''),header=T,sep="",na="NA",fill=T) 

cbas1a     <- subset(stds1a ,name=="CBAp")$value[3] 
cbas1astd  <- subset(stds1a ,name=="CBAp")$std[3] #reclutamiento medios
cbas2a     <- subset(stds2a ,name=="CBAp")$value[3] 
cbas2astd  <- subset(stds2a ,name=="CBAp")$std[3] #reclutamiento medios
cbas3a     <- subset(stds3a ,name=="CBAp")$value[3] 
cbas3astd  <- subset(stds3a ,name=="CBAp")$std[3] #reclutamiento medios

q       <- seq(0.1,0.5,0.1)  # niveles de riesgo (cuantiles)                            
nq      <- length(q)                                                                                   
CBAs1a     <- rep(0,nq)
CBAs2a     <- rep(0,nq)
CBAs3a   <- rep(0,nq)
buffer1a   <- rep(0,nq)
buffer2a   <- rep(0,nq)
buffer3a   <- rep(0,nq)

for(j in 1:nq){
  CBAs1a[j]<-qnorm(q[j],cbas1a,cbas1astd )
  CBAs2a[j]<-qnorm(q[j],cbas2a,cbas2astd )
  CBAs3a[j]<-qnorm(q[j],cbas3a,cbas3astd )
  }
for(j in 1:nq){
    buffer1a[j] <-round(1-CBAs1a[j]/CBAs1a[5],2)
    buffer2a[j] <-round(1-CBAs2a[j]/CBAs2a[5],2)
    buffer3a[j] <-round(1-CBAs3a[j]/CBAs3a[5],2)
  }

tCBA1<-cbind(percentil=c(seq(10,50,10)),CBA_Rmed=round(CBAs1a,0),CBA_Ralto=round(CBAs2a,0),CBA_Rbajo=round(CBAs3a,0))
#kable((tCBA1))
tCBA2<-cbind(percentil=c(seq(10,50,10)),CBA_Ralto=round(CBAs2a,0),Resguardo=buffer2a)
#kable((tCBA2))
tCBA3<-cbind(percentil=c(seq(10,50,10)),CBA_Rbajo=round(CBAs3a,0),Resguardo=buffer3a)
#kable((tCBA3))
```

```{=tex}
\footnotesize
\begin{center} 
 \textbf{Tabla 16.}
 \end{center}
 \begin{center} 
 \vspace{-0.2cm} CBA proyectada para el año 2020 (Asesoría de septiembre 2019) y CBA proyectada para el año 2021 (asesoría septiembre 2020)  para percentiles de probabilidad entre el 10\% y 50\% y bajo tres escenarios de reclutamiento, utilizando el modelo base y alternativo.
 \end{center}
 \vspace{-0.2cm}
```
\footnotesize

+----------------+----------------+--------------+---------------+---------------+---------------+
| Modelo         | Año proyección | Percentil de | Reclutamiento | Reclutamiento | Reclutamiento |
|                |                |              |               |               |               |
|                |                | probabilidad | medio         | alto          | bajo          |
|                |                |              |               |               |               |
|                |                | de captura   |               |               |               |
+:==============:+:==============:+:============:+:=============:+:=============:+:=============:+
|                |                | 10%          | 7415          | 10716         | 6142          |
+----------------+----------------+--------------+---------------+---------------+---------------+
|                |                | 20%          | 8432          | 11952         | 7154          |
+----------------+----------------+--------------+---------------+---------------+---------------+
| M. base        | CBA 2020       | 30%          | 9166          | 12842         | 7883          |
+----------------+----------------+--------------+---------------+---------------+---------------+
|                |                | 40%          | 9793          | 13604         | 8506          |
+----------------+----------------+--------------+---------------+---------------+---------------+
|                |                | 50%          | 10379         | 14315         | 9089          |
+----------------+----------------+--------------+---------------+---------------+---------------+
|                |                |              |               |               |               |
+----------------+----------------+--------------+---------------+---------------+---------------+
|                |                | 10%          | 6107          | 7415          | 5425          |
+----------------+----------------+--------------+---------------+---------------+---------------+
|                |                | 20%          | 7149          | 8526          | 6459          |
+----------------+----------------+--------------+---------------+---------------+---------------+
| M. alternativo | CBA 2020       | 30%          | 7901          | 9328          | 7204          |
+----------------+----------------+--------------+---------------+---------------+---------------+
|                |                | 40%          | 8543          | 10012         | 7841          |
+----------------+----------------+--------------+---------------+---------------+---------------+
|                |                | 50%          | 9143          | 10652         | 8436          |
+----------------+----------------+--------------+---------------+---------------+---------------+
|                |                |              |               |               |               |
+----------------+----------------+--------------+---------------+---------------+---------------+
|                |                | 10%          | 10899         | 14253         | 10005         |
+----------------+----------------+--------------+---------------+---------------+---------------+
|                |                | 20%          | 12213         | 15766         | 11300         |
+----------------+----------------+--------------+---------------+---------------+---------------+
| M. base        | CBA 2021       | 30%          | 13161         | 16857         | 12234         |
+----------------+----------------+--------------+---------------+---------------+---------------+
|                |                | 40%          | 13971         | 17789         | 13032         |
+----------------+----------------+--------------+---------------+---------------+---------------+
|                |                | 50%          | 14728         | 18660         | 13778         |
+----------------+----------------+--------------+---------------+---------------+---------------+
|                |                |              |               |               |               |
+----------------+----------------+--------------+---------------+---------------+---------------+
|                |                | 10%          | 8932          | 9961          | 8451          |
+----------------+----------------+--------------+---------------+---------------+---------------+
|                |                | 20%          | 10294         | 11364         | 9799          |
+----------------+----------------+--------------+---------------+---------------+---------------+
| M. alternativo | CBA 2021       | 30%          | 11277         | 12377         | 10771         |
+----------------+----------------+--------------+---------------+---------------+---------------+
|                |                | 40%          | 12116         | 13242         | 11601         |
+----------------+----------------+--------------+---------------+---------------+---------------+
|                |                | 50%          | 12900         | 14050         | 12377         |
+----------------+----------------+--------------+---------------+---------------+---------------+

```{=tex}
\normalsize
\pagebreak
```
```{r CBAalatalla_CBA2020_sept2019,warning=F, include=T, message=F, echo=FALSE,fig.height=5,fig.width=7,fig.align="center",fig.path="Figuras/",dev=c('pdf')}

dirb<-paste(dir.0,"/cba_septiembre2019_base",sep="")
setwd(dirb)
reps1b     <- reptoRlist("MTT0819s1.rep")  
reps2b     <- reptoRlist("MTT0819s2.rep") 
reps3b     <- reptoRlist("MTT0819s3.rep") 

dira<-paste(dir.0,"/cba_septiembre2019_alternativo",sep="")
setwd(dira)
reps1a     <- reptoRlist("MAT0919s1.rep")  
reps2a     <- reptoRlist("MAT0919s2.rep") 
reps3a     <- reptoRlist("MAT0919s3.rep") 

tallas<-seq(5.5,20,0.5)

par(mfcol=c(2,2),mar=c(4,4,1,1)+0.5)

plot(tallas,reps1b$CTPp,type="l",ylim=c(0,1500),main="CBA 2020 a la talla - M. base",
     ylab="CBA proyectada (t)",xlab="Tallas (cm)",cex.axis=0.8,cex.main=0.9,cex.lab=0.8)
lines(tallas,reps2b$CTPp,col=2)
lines(tallas,reps3b$CTPp,col=3)

plot(tallas,reps1a$CTPp,type="l",ylim=c(0,1500),main="CBA 2020 a la talla - M. alternativo",
     ylab="CBA proyectada (t)",xlab="Tallas (cm)",cex.axis=0.8,cex.main=0.9,cex.lab=0.8)
lines(tallas,reps2a$CTPp,col=2)
lines(tallas,reps3a$CTPp,col=3)


plot(seq(10,50,10),CBAs1b,type="o", ylab="CBA toneladas",xlab="Percentil de probabilidad de captura",main="modelo base - CBA 2020",ylim=c(1000,16000),cex.axis=0.8,cex.main=0.9,cex.lab=0.8)
lines(seq(10,50,10),CBAs1b,type="o",col=1)
lines(seq(10,50,10),CBAs2b,type="o",col=2)
lines(seq(10,50,10),CBAs3b,type="o",col=3)
legend(12,16000,c("Rmed","Ralto","Rbajo"),col=c(1,2,3),lwd=1,bty="n",cex=0.8)


plot(seq(10,50,10),CBAs1a,type="o", ylab="CBA toneladas",xlab="Percentil de probabilidad captura",main="modelo alternativo - CBA 2020",ylim=c(1000,16000),cex.axis=0.8,cex.main=0.9,cex.lab=0.8)
lines(seq(10,50,10),CBAs1a,type="o",col=1)
lines(seq(10,50,10),CBAs2a,type="o",col=2)
lines(seq(10,50,10),CBAs3a,type="o",col=3)
legend(12,16000,c("Rmed","Ralto","Rbajo"),col=c(1,2,3),lwd=1,bty="n",cex=0.8)

```

```{=tex}
\small 
\textbf{Figura 42}. CBA proyectada al 2020 estimada a la talla (panel izquierdo)  y  para cada percentil de captura (panel derecho). Estimaciones realizadas bajo los tres escenarios de reclutamiento por el modelo base y alternativo.
\normalsize
```
```{r Densidad_CBA2020_sept2019,warning=F, include=T, message=F, echo=FALSE,fig.height=2.9,fig.width=7,fig.align="center",fig.path="Figuras/",dev=c('pdf')}

### *modelo base*
xcb1 <-rnorm(1000, mean = cbas1b, sd = cbas1bstd)
xcb  <-seq(min(xcb1),max(xcb1),0.5)
ycb  <-dnorm(xcb, mean = cbas1b, sd =cbas1bstd)
iccb <-qnorm(c(0.05,0.95,0.5),cbas1b,cbas1bstd)
xxcb <-c(xcb[xcb>=iccb[1]&xcb<=iccb[2]],rev(xcb[xcb>=iccb[1]&xcb<=iccb[2]]))
yycb <-c(ycb[xcb>=iccb[1]&xcb<=iccb[2]],rep(0,length(ycb[xcb>=iccb[1]&xcb<=iccb[2]])))

### *modelo altarnativo*
xca1 <-rnorm(1000, mean = cbas1a, sd = cbas1astd)
xca  <-seq(min(xca1),max(xca1),0.5)
yca  <-dnorm(xca, mean = cbas1a, sd =cbas1astd)
icca <-qnorm(c(0.05,0.95,0.5),cbas1a,cbas1astd)
xxca <-c(xca[xca>=icca[1]&xca<=icca[2]],rev(xca[xca>=icca[1]&xca<=icca[2]]))
yyca <-c(yca[xca>=icca[1]&xca<=icca[2]],rep(0,length(yca[xca>=icca[1]&xca<=icca[2]])))

par(mfcol=c(1,2),mar=c(4,4,1,1)+0.5)
plot(xca,yca,type="l",ylab="Densidad de probabilidad",xaxs="i",yaxs= "i",ylim=c(0,0.00022),xlim=c(1000,20000),xlab="CBA 2020 (toneladas)", main="Escenario Rmed 2020",cex.axis=0.7,cex.main=0.7,cex.lab=0.7)
polygon(xxca,yyca,col=gray(0.8,0.7),border="gray80")
polygon(xxcb,yycb,col=gray(0.5,0.5),border="gray80")
lines(xcb,ycb,lwd=1,lty=1)
lines(xca,yca,lwd=1,col="red2",lty=1)
legend(2000,0.00022,c(paste("base_IC95% = [",round(iccb[1],0),"-",round(iccb[2],0),"]",sep=" "),paste("alternativo_IC95% = [",round(icca[1],0),"-",round(icca[2],0),"]",sep=" ")), lty=c(1,1),col=c("black","red2"),bty="n",lwd=1,cex=0.6)
box()

plot(seq(10,50,10),CBAs1b,type="o", ylab="CBA toneladas",xlab="Percentil de probabilidad de captura",main="Escenario Rmed 2020",ylim=c(1000,16000),cex.axis=0.7,cex.main=0.7,cex.lab=0.7)
lines(seq(10,50,10),CBAs1a,type="o",col=2)
legend(12,5000,c("modelo base","modelo alternativo"),col=c(1,2),lwd=1,bty="n",cex=0.7)

```

```{=tex}
\small 
\textbf{Figura 43}. Distribución de probabilidad de la CBA proyectada para el año 2020 (panel izquierdo) y la CBA estimada para cada percentil de probabilidad de captura (10\% - 50\%) estimada con el modelo base y alternativo.
\normalsize
```
```{r cba2021_modelobase,warning=F, include=T, message=F, echo=FALSE,eval=TRUE }

dir<-paste(dir.0,"/cba_septiembre2020_base",sep="")
admb<-"/MTT0920"

stds1b     <- read.table(paste(dir,admb,"s1.std", sep=''),header=T,sep="",na="NA",fill=T)
stds2b     <- read.table(paste(dir,admb,"s2.std", sep=''),header=T,sep="",na="NA",fill=T)
stds3b     <- read.table(paste(dir,admb,"s3.std", sep=''),header=T,sep="",na="NA",fill=T) 
# es tres porque proyecté solo un año
# es 11 cuando proyecto 5 años
cbas1b     <- subset(stds1b ,name=="Yp")$value[3] 
cbas1bstd  <- subset(stds1b ,name=="Yp")$std[3] #reclutamiento medios
cbas2b     <- subset(stds2b ,name=="Yp")$value[3] 
cbas2bstd  <- subset(stds2b ,name=="Yp")$std[3] #reclutamiento medios
cbas3b     <- subset(stds3b ,name=="Yp")$value[3] 
cbas3bstd  <- subset(stds3b ,name=="Yp")$std[3] #reclutamiento medios

q       <- seq(0.1,0.5,0.1)  # niveles de riesgo (cuantiles)                             
nq      <- length(q)                                                                                   
CBAs1b     <- rep(0,nq)
CBAs2b     <- rep(0,nq)
CBAs3b   <- rep(0,nq)
buffer1b   <- rep(0,nq)
buffer2b   <- rep(0,nq)
buffer3b   <- rep(0,nq)

for(j in 1:nq){
  CBAs1b[j]<-qnorm(q[j],cbas1b,cbas1bstd )
  CBAs2b[j]<-qnorm(q[j],cbas2b,cbas2bstd )
  CBAs3b[j]<-qnorm(q[j],cbas3b,cbas3bstd )
  }
for(j in 1:nq){
    buffer1b[j] <-round(1-CBAs1b[j]/CBAs1b[5],2)
    buffer2b[j] <-round(1-CBAs2b[j]/CBAs2b[5],2)
    buffer3b[j] <-round(1-CBAs3b[j]/CBAs3b[5],2)
  }

tCBA1<-cbind(percentil=c(seq(10,50,10)),CBA_Rmed=round(CBAs1b,0),CBA_Ralto=round(CBAs2b,0),CBA_Rbajo=round(CBAs3b,0))
#kable((tCBA1))
tCBA2<-cbind(percentil=c(seq(10,50,10)),CBA_Ralto=round(CBAs2b,0),Resguardo=buffer2b)
#kable((tCBA2))
tCBA3<-cbind(percentil=c(seq(10,50,10)),CBA_Rbajo=round(CBAs3b,0),Resguardo=buffer3b)
#kable((tCBA3))
```

```{r cba2021_modeloalternativo,warning=F, include=T, message=F, echo=FALSE,eval=TRUE }

dir<-paste(dir.0,"/cba_septiembre2020_alternativo",sep="")
admb<-"/MAT0920"

stds1a     <- read.table(paste(dir,admb,"s1.std", sep=''),header=T,sep="",na="NA",fill=T)
stds2a     <- read.table(paste(dir,admb,"s2.std", sep=''),header=T,sep="",na="NA",fill=T)
stds3a     <- read.table(paste(dir,admb,"s3.std", sep=''),header=T,sep="",na="NA",fill=T) 

cbas1a     <- subset(stds1a ,name=="CBAp")$value[3] 
cbas1astd  <- subset(stds1a ,name=="CBAp")$std[3] #reclutamiento medios
cbas2a     <- subset(stds2a ,name=="CBAp")$value[3] 
cbas2astd  <- subset(stds2a ,name=="CBAp")$std[3] #reclutamiento medios
cbas3a     <- subset(stds3a ,name=="CBAp")$value[3] 
cbas3astd  <- subset(stds3a ,name=="CBAp")$std[3] #reclutamiento medios

q       <- seq(0.1,0.5,0.1)  # niveles de riesgo (cuantiles)                            
nq      <- length(q)                                                                                   
CBAs1a     <- rep(0,nq)
CBAs2a     <- rep(0,nq)
CBAs3a   <- rep(0,nq)
buffer1a   <- rep(0,nq)
buffer2a   <- rep(0,nq)
buffer3a   <- rep(0,nq)

for(j in 1:nq){
  CBAs1a[j]<-qnorm(q[j],cbas1a,cbas1astd )
  CBAs2a[j]<-qnorm(q[j],cbas2a,cbas2astd )
  CBAs3a[j]<-qnorm(q[j],cbas3a,cbas3astd )
  }
for(j in 1:nq){
    buffer1a[j] <-round(1-CBAs1a[j]/CBAs1a[5],2)
    buffer2a[j] <-round(1-CBAs2a[j]/CBAs2a[5],2)
    buffer3a[j] <-round(1-CBAs3a[j]/CBAs3a[5],2)
  }

tCBA1<-cbind(percentil=c(seq(10,50,10)),CBA_Rmed=round(CBAs1a,0),CBA_Ralto=round(CBAs2a,0),CBA_Rbajo=round(CBAs3a,0))
#kable((tCBA1))
tCBA2<-cbind(percentil=c(seq(10,50,10)),CBA_Ralto=round(CBAs2a,0),Resguardo=buffer2a)
#kable((tCBA2))
tCBA3<-cbind(percentil=c(seq(10,50,10)),CBA_Rbajo=round(CBAs3a,0),Resguardo=buffer3a)
#kable((tCBA3))
```

```{r Rproy,warning=F, include=T, message=F, echo=FALSE,fig.height=5,fig.width=7,fig.align="center",fig.path="Figuras/",dev=c('pdf')}

dirb<-paste(dir.0,"/cba_septiembre2020_base",sep="")
setwd(dirb)
reps1b     <- reptoRlist("MTT0920s1.rep")  
reps2b     <- reptoRlist("MTT0920s2.rep") 
reps3b     <- reptoRlist("MTT0920s3.rep") 

dira<-paste(dir.0,"/cba_septiembre2020_alternativo",sep="")
setwd(dira)
reps1a     <- reptoRlist("MAT0920s1.rep")  
reps2a     <- reptoRlist("MAT0920s2.rep") 
reps3a     <- reptoRlist("MAT0920s3.rep") 


par(mfcol=c(2,2),mar=c(4,4,1,1)+0.5)

plot(tallas,reps1b$CTPp,type="l",ylim=c(0,3000),main="CBA 2021 a la talla - M. base",
     ylab="CBA proyectada (t)",xlab="Tallas (cm)",cex.axis=0.8,cex.main=0.8,cex.lab=0.8)
lines(tallas,reps2b$CTPp,col=2)
lines(tallas,reps3b$CTPp,col=3)

plot(tallas,reps1a$CTPp,type="l",ylim=c(0,3000),main="CBA 2021 a la talla - M. alternativo",
     ylab="CBA proyectada (t)",xlab="Tallas (cm)",cex.axis=0.8,cex.main=0.8,cex.lab=0.8)
lines(tallas,reps2a$CTPp,col=2)
lines(tallas,reps3a$CTPp,col=3)

plot(seq(10,50,10),CBAs1b,type="o", ylab="CBA toneladas",xlab="Percentil de probabilidad de captura",main="modelo base - CBA 2021",ylim=c(1000,19000),cex.axis=0.8,cex.main=0.8,cex.lab=0.8)
lines(seq(10,50,10),CBAs1b,type="o",col=1)
lines(seq(10,50,10),CBAs2b,type="o",col=2)
lines(seq(10,50,10),CBAs3b,type="o",col=3)
legend(30,11000,c("Rmed","Ralto","Rbajo"),col=c(1,2,3),lwd=1,bty="n",cex=0.8)


plot(seq(10,50,10),CBAs1a,type="o", ylab="CBA toneladas",xlab="Percentil de probabilidad de captura",main="modelo alternativo - CBA 2021",ylim=c(1000,19000),cex.axis=0.8,cex.main=0.8,cex.lab=0.8)
lines(seq(10,50,10),CBAs1a,type="o",col=1)
lines(seq(10,50,10),CBAs2a,type="o",col=2)
lines(seq(10,50,10),CBAs3a,type="o",col=3)
legend(12,18000,c("Rmed","Ralto","Rbajo"),col=c(1,2,3),lwd=1,bty="n",cex=0.8)



```

```{=tex}
\small 
\textbf{Figura 44}. CBA proyectada al 2021 estimada a la talla (panel izquierdo) y para cada percentil de captura (panel derecho). Estimaciones realizadas bajo los tres escenarios de reclutamiento por el modelo base y alternativo.
\normalsize
```
```{r Densidad_CBA2021,warning=F, include=T, message=F, echo=FALSE,fig.height=3,fig.width=7,fig.align="center",fig.path="Figuras/",dev=c('pdf')}

### *modelo base*
xcb1 <-rnorm(1000, mean = cbas1b, sd = cbas1bstd)
xcb  <-seq(min(xcb1),max(xcb1),0.5)
ycb  <-dnorm(xcb, mean = cbas1b, sd =cbas1bstd)
iccb <-qnorm(c(0.05,0.95,0.5),cbas1b,cbas1bstd)
xxcb <-c(xcb[xcb>=iccb[1]&xcb<=iccb[2]],rev(xcb[xcb>=iccb[1]&xcb<=iccb[2]]))
yycb <-c(ycb[xcb>=iccb[1]&xcb<=iccb[2]],rep(0,length(ycb[xcb>=iccb[1]&xcb<=iccb[2]])))

### *modelo altarnativo*
xca1 <-rnorm(1000, mean = cbas1a, sd = cbas1astd)
xca  <-seq(min(xca1),max(xca1),0.5)
yca  <-dnorm(xca, mean = cbas1a, sd =cbas1astd)
icca <-qnorm(c(0.05,0.95,0.5),cbas1a,cbas1astd)
xxca <-c(xca[xca>=icca[1]&xca<=icca[2]],rev(xca[xca>=icca[1]&xca<=icca[2]]))
yyca <-c(yca[xca>=icca[1]&xca<=icca[2]],rep(0,length(yca[xca>=icca[1]&xca<=icca[2]])))

par(mfcol=c(1,2),mar=c(4,4,1,1)+0.5)
plot(xca,yca,type="l",ylab="Densidad de probabilidad",xaxs="i",yaxs= "i",ylim=c(0,0.00019),xlim=c(1000,25000),xlab="CBA 2021 (toneladas)",main="Escenario Rmed 2021", cex.axis=0.7,cex.main=0.7,cex.lab=0.7)
polygon(xxca,yyca,col=gray(0.8,0.7),border="gray80")
polygon(xxcb,yycb,col=gray(0.5,0.5),border="gray80")
lines(xcb,ycb,lwd=1,lty=1)
lines(xca,yca,lwd=1,col="red2",lty=1)
legend(2000,0.00019,c(paste("base_IC95% = [",round(iccb[1],0),"-",round(iccb[2],0),"]",sep=" "),paste("alternativo_IC95% = [",round(icca[1],0),"-",round(icca[2],0),"]",sep=" ")), lty=c(1,1),col=c("black","red2"),bty="n",lwd=1,cex=0.7)
box()

plot(seq(10,50,10),CBAs1b,type="o", ylab="CBA toneladas",xlab="Percentil de probabilidad de captura",main="Escenario Rmed 2021",ylim=c(1000,19000),cex.axis=0.7,cex.main=0.7,cex.lab=0.7)
lines(seq(10,50,10),CBAs1a,type="o",col=2)
legend(12,18000,c("modelo base","modelo alternativo"),col=c(1,2),lwd=1,bty="n",cex=0.6)

```

```{=tex}
\small 
\textbf{Figura 45}. Distribución de probabilidad de la CBA proyectada para el año 2021 (panel izquierdo) y la CBA estimada para cada percentil de probabilidad de captura (10\% - 50\%) estimada con el modelo base y alternativo.
\normalsize
```
\pagebreak

```{r cba2020_modelobase,warning=F, include=T, message=F, echo=FALSE,eval=TRUE }

dir<-paste(dir.0,"/cba_junio2020_base",sep="")
admb<-"/MTT0520"

std0     <- read.table(paste(dir,admb,"s1.std", sep=''),header=T,sep="",na="NA",fill=T)
cbas0     <- subset(std0,name=="Yact")$value[3] 
cbas0std  <- subset(std0,name=="Yact")$std[3] #reclutamiento medios

q       <- seq(0.1,0.5,0.1)  # niveles de riesgo (cuantiles)                                
nq      <- length(q)                                                                                   
CBAs0     <- rep(0,nq)
buffer0   <- rep(0,nq)
for(j in 1:nq){CBAs0[j]<-qnorm(q[j],cbas0,cbas0std)}
for(j in 1:nq){buffer0[j] <-round(1-CBAs0[j]/CBAs0[5],2)}

tCBA<-cbind(percentil=c(seq(10,50,10)),CBA_base=round(CBAs0,0),Resguardo=buffer0)
#kable((tCBA))

```

```{r cba2020_modeloalternativo,warning=F, include=T, message=F, echo=FALSE,eval=TRUE }

dir<-paste(dir.0,"/cba_junio2020_alternativo",sep="")
admb<-"/MAT0420"

std1     <- read.table(paste(dir,admb,"s1.std", sep=''),header=T,sep="",na="NA",fill=T)

cbas1     <- subset(std1,name=="CBA")$value[1] 
cbas1std  <- subset(std1,name=="CBA")$std[1] #reclutamiento medios

q       <- seq(0.1,0.5,0.1)  # niveles de riesgo (cuantiles)                                
nq      <- length(q)                                                                                   
CBAs1     <- rep(0,nq)
buffer1   <- rep(0,nq)

for(j in 1:nq){CBAs1[j]<-qnorm(q[j],cbas1,cbas1std)}
for(j in 1:nq){buffer1[j] <-round(1-CBAs1[j]/CBAs1[5],2)}

tCBA1<-cbind(percentil=c(seq(10,50,10)),CBA_alternativo=round(CBAs1,0),Resguardo=buffer1)
#kable((tCBA1))

tCBA2<-cbind(percentil=c(seq(10,50,10)),CBA_base=round(CBAs0,0),ResguardoBase=buffer0,CBA_alternativo=round(CBAs1,0),Resguardoalternativo=buffer1)
#kable((tCBA2))
```

```{=tex}
\small
\begin{center} 
 \textbf{Tabla 17.}
 \end{center}
 \begin{center} 
 \vspace{-0.2cm} Revisión de CBA 2020 (Asesoría de junio 2020)  para percentiles de probabilidad entre el 10\% y 50\% y bajo tres escenarios de reclutamiento, utilizando el modelo base y alternativo.
 \end{center}
 \vspace{-0.2cm}
```
\footnotesize

+----------------+----------+--------------+-------+-----------+
| Modelo         | Año      | Percentil de | CBA   | Resguardo |
|                |          |              |       |           |
|                |          | probabilidad |       |           |
+:==============:+:========:+:============:+:=====:+:=========:+
|                |          | 10%          | 12898 | 0.25      |
+----------------+----------+--------------+-------+-----------+
|                |          | 20%          | 14393 | 0.17      |
+----------------+----------+--------------+-------+-----------+
| M. base        | CBA 2020 | 30%          | 15471 | 0.10      |
+----------------+----------+--------------+-------+-----------+
|                |          | 40%          | 16391 | 0.05      |
+----------------+----------+--------------+-------+-----------+
|                |          | 50%          | 17252 | 0.00      |
+----------------+----------+--------------+-------+-----------+
|                |          |              |       |           |
+----------------+----------+--------------+-------+-----------+
|                |          | 10%          | 12391 | 0.28      |
+----------------+----------+--------------+-------+-----------+
|                |          | 20%          | 14011 | 0.18      |
+----------------+----------+--------------+-------+-----------+
| M. alternativo | CBA 2020 | 30%          | 15179 | 0.11      |
+----------------+----------+--------------+-------+-----------+
|                |          | 40%          | 16178 | 0.05      |
+----------------+----------+--------------+-------+-----------+
|                |          | 50%          | 17111 | 0.00      |
+----------------+----------+--------------+-------+-----------+

\normalsize

```{r Densidad_CBA2020,warning=F, include=T, message=F, echo=FALSE,fig.height=5.8,fig.width=4,fig.align="center",fig.path="Figuras/",dev=c('pdf')}

### *modelo base*
xcb1 <-rnorm(1000, mean = cbas0, sd = cbas0std)
xcb  <-seq(min(xcb1),max(xcb1),0.5)
ycb  <-dnorm(xcb, mean = cbas0, sd =cbas0std)
iccb <-qnorm(c(0.05,0.95,0.5),cbas0,cbas0std)
xxcb <-c(xcb[xcb>=iccb[1]&xcb<=iccb[2]],rev(xcb[xcb>=iccb[1]&xcb<=iccb[2]]))
yycb <-c(ycb[xcb>=iccb[1]&xcb<=iccb[2]],rep(0,length(ycb[xcb>=iccb[1]&xcb<=iccb[2]])))

### *modelo altarnativo*
xca1 <-rnorm(1000, mean = cbas1, sd = cbas1std)
xca  <-seq(min(xca1),max(xca1),0.5)
yca  <-dnorm(xca, mean = cbas1, sd =cbas1std)
icca <-qnorm(c(0.05,0.95,0.5),cbas1,cbas1std)
xxca <-c(xca[xca>=icca[1]&xca<=icca[2]],rev(xca[xca>=icca[1]&xca<=icca[2]]))
yyca <-c(yca[xca>=icca[1]&xca<=icca[2]],rep(0,length(yca[xca>=icca[1]&xca<=icca[2]])))

par(mfcol=c(3,1),mar=c(4,4,1,1)+0.5)

tallas<-seq(5.5,20,0.5)
#par(mfcol=c(1,1),mar=c(4,4,1,1)+0.5)
plot(tallas,rep1$CTP,type="l",ylim=c(0,3000),main="CBA 2020 a la talla",
     ylab="CBA 2020 (t)",xlab="Tallas (cm)",col=2,cex.axis=0.7,cex.main=0.7,cex.lab=0.7)
lines(tallas,rep0$CTP,type="l",ylim=c(0,3000),col=1)

plot(xca,yca,type="l",ylab="Densidad de probabilidad",xaxs="i",yaxs= "i",ylim=c(0,0.00015),xlim=c(5000,30000),xlab="CBA 2020 (toneladas)",cex.axis=0.7,cex.main=0.7,cex.lab=0.7)
polygon(xxca,yyca,col=gray(0.8,0.7),border="gray80")
polygon(xxcb,yycb,col=gray(0.5,0.5),border="gray80")
lines(xcb,ycb,lwd=1,lty=1)
lines(xca,yca,lwd=1,col="red2",lty=1)
legend(5000,0.00015,c(paste("base_IC95% = [",round(iccb[1],0),"-",round(iccb[2],0),"]",sep=" "),paste("alternativo_IC95% = [",round(icca[1],0),"-",round(icca[2],0),"]",sep=" ")), lty=c(1,1),col=c("black","red2"),bty="n",lwd=1,cex=0.7)
box()

plot(seq(10,50,10),CBAs0,type="o", ylab="CBA toneladas",xlab="Percentil de probabilidad de captura",main="",ylim=c(10000,20000),cex.axis=0.7,cex.main=0.7,cex.lab=0.7)
lines(seq(10,50,10),CBAs1,type="o",col=2)
legend(20,12000,c("modelo base","modelo alternativo"),col=c(1,2),lwd=1,bty="n",cex=0.7)

```

```{=tex}
\small 
\textbf{Figura 46}. Actualización de CBA 2020 estimada a la talla (panel superior). Distribución de probabilidad de la actualización de CBA 2020 (panel central) y la CBA estimada para cada percentil de probabilidad  (10\% - 50\%) estimada con el modelo base y alternativo.
\normalsize
```
\normalsize